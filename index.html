<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekday.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrBefore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrAfter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    
    <script>
        dayjs.extend(dayjs_plugin_isBetween);
        dayjs.extend(dayjs_plugin_weekday);
        dayjs.extend(dayjs_plugin_isSameOrBefore);
        dayjs.extend(dayjs_plugin_isSameOrAfter);
        dayjs.extend(dayjs_plugin_customParseFormat);
        dayjs.locale('zh-cn'); // è®¾ç½®ä¸­æ–‡è¯­è¨€ç¯å¢ƒï¼Œé»˜è®¤å‘¨ä¸€ä¸ºä¸€å‘¨çš„å¼€å§‹
    </script>
    
    <style>
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; background: #f0f2f5;padding-bottom: env(safe-area-inset-bottom);}
        /* å†²çªä»»åŠ¡æ ‡çº¢ */
        .conflict-border { border: 2px solid #ef4444 !important; background-color: #fef2f2 !important; }
        .timeline-slot { transition: all 0.3s ease; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-bg { z-index: 50; }
        .modal-content { z-index: 60; }
        /* å‘¨/æ—¥è§†å›¾ä¸­æ¯å°æ—¶é«˜åº¦å®šä¹‰ */
        .hour-slot { height: 60px; } 
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col">

<div id="app" class="flex-1 flex flex-col h-full overflow-hidden">
        <div class="space-x-3 flex items-center">
            <button @click="triggerImport" class="text-sm text-gray-600 hover:text-blue-600">ğŸ“¥ æœ¬åœ°å¯¼å…¥</button>
            <button @click="exportData" class="text-sm text-gray-600 hover:text-green-600">ğŸ“¤ æœ¬åœ°å¯¼å‡º</button>
            <button @click="openCloudSyncModal" class="text-sm text-gray-600 hover:text-purple-600">â˜ï¸ äº‘ç«¯åŒæ­¥</button>
            <input type="file" ref="fileInput" @change="handleImport" class="hidden" accept=".json">
        </div>
    </header>
    
    <div class="flex-1 flex overflow-hidden">
        
        <main class="flex-1 overflow-hidden relative bg-gray-50 flex flex-col">
            
            <div v-if="['day', 'schedule', 'month'].includes(currentView)" class="shrink-0 bg-white shadow-md border-b sticky top-0 z-30">
                <div class="flex space-x-6 px-6 py-2">
                    <button @click="currentView = 'day'" 
                            :class="{'text-blue-600 border-b-2 border-blue-600 font-bold': currentView === 'day'}"
                            class="pb-1 text-sm text-gray-600 hover:text-blue-600 transition">
                        â˜€ï¸ æ—¥è§†å›¾
                    </button>
                    <button @click="currentView = 'schedule'" 
                            :class="{'text-blue-600 border-b-2 border-blue-600 font-bold': currentView === 'schedule'}"
                            class="pb-1 text-sm text-gray-600 hover:text-blue-600 transition">
                        ğŸ—“ï¸ å‘¨æ’ç¨‹
                    </button>
                    <button @click="currentView = 'month'" 
                            :class="{'text-blue-600 border-b-2 border-blue-600 font-bold': currentView === 'month'}"
                            class="pb-1 text-sm text-gray-600 hover:text-blue-600 transition">
                        ğŸ“… æœˆå†
                    </button>
                </div>
            </div>

            <div v-if="currentView === 'month'" class="flex-1 flex flex-col p-4 overflow-hidden">
                <div class="bg-white p-3 rounded shadow-sm mb-4 shrink-0 flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <button @click="changeMonth(-1)" class="p-1 hover:bg-gray-100 rounded text-xl">â¬…</button>
                        <div class="text-lg font-bold">
                            {{ dayjs(selectedMonthStart).format('YYYYå¹´MMæœˆ') }}
                        </div>
                        <button @click="changeMonth(1)" class="p-1 hover:bg-gray-100 rounded text-xl">â¡</button>
                        <button @click="goToTodayMonth" class="text-xs text-blue-500 underline">å›åˆ°æœ¬æœˆ</button>
                    </div>
                </div>

                <div class="flex-1 bg-white rounded shadow p-4 overflow-y-auto">
                    <div class="grid grid-cols-7 text-center font-bold text-gray-600 border-b pb-2 mb-2">
                        <div v-for="d in ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥']" :key="d">{{ d }}</div>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-1 h-[calc(100%-40px)]">
                        <div v-for="d in monthCalendar" :key="d.date" 
                             @click="goToDay(d.date)"
                             class="p-2 border rounded cursor-pointer transition relative"
                             :class="[d.isCurrentMonth ? 'bg-white hover:bg-blue-50' : 'bg-gray-100 text-gray-400 hover:bg-gray-200', 
                                     {'border-blue-500 ring-2 ring-blue-200 font-bold': d.date === todayDate}]"
                            >
                            <div class="text-sm font-bold">{{ dayjs(d.date).date() }}</div>
                            <div v-if="d.count > 0" class="mt-2 text-xs">
                                <span v-if="d.habitCount > 0" class="block text-green-600">âœ… {{ d.habitDone }}/{{ d.habitCount }} ä¹ æƒ¯</span>
                                <span v-if="d.taskCount > 0" class="block text-blue-600">ğŸ“ {{ d.taskCount }} ä»»åŠ¡</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="currentView === 'day'" class="flex-1 flex flex-col p-4 overflow-hidden">
    <div class="bg-white p-3 rounded shadow-sm mb-4 shrink-0 flex justify-between items-center">
        <div class="flex items-center space-x-4">
            <button @click="changeDate(-1)" class="p-1 hover:bg-gray-100 rounded text-xl">â¬…</button>
            <div class="text-center">
                <div class="text-xl font-bold">{{ dayjs(selectedDate).format('YYYYå¹´MMæœˆDDæ—¥') }}</div>
                <div class="text-xs text-gray-500">{{ getWeekDay(selectedDate) }} ({{ dayTasks.length }} é¡¹ä»»åŠ¡)</div>
            </div>
            <button @click="changeDate(1)" class="p-1 hover:bg-gray-100 rounded text-xl">â¡</button>
            <button @click="selectedDate = todayDate" class="text-xs text-blue-500 underline">å›åˆ°ä»Šå¤©</button>

            <div class="flex items-center space-x-2 ml-4">
                <label class="text-sm text-gray-600">ç­›é€‰ä¼˜å…ˆçº§:</label>
                <select v-model="selectedPriorityFilter" class="p-1 border rounded text-sm">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="p1">P1 ğŸ”´</option>
                    <option value="p2">P2 ğŸŸ¡</option>
                    <option value="p3">P3 ğŸ”µ</option>
                    <option value="p4">P4 âš«</option>
                </select>
            </div>
        </div>
        <button @click="openTaskModal('create', null, selectedDate)" class="bg-blue-600 text-white px-3 py-1 rounded shadow text-sm">+ æ’å…¥ä»»åŠ¡</button>
    </div>
    <div class="flex items-center space-x-2 ml-4">
                <button @click="toggleExchangeMode" 
                        class="px-2 py-1 text-sm rounded border"
                        :class="exchangeMode ? 'bg-blue-600 text-white border-blue-700' : 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200'">
                    {{ exchangeMode ? 'ğŸ”„ äº¤æ¢æ¨¡å¼ä¸­(ç‚¹å‡»äº¤æ¢)' : 'ğŸ”„ äº¤æ¢æ—¶é—´' }}
                </button>
    </div>
    <div class="flex-1 overflow-y-auto bg-white rounded shadow p-4">
         <h3 class="text-sm font-bold mb-3 border-b pb-2">ä»Šæ—¥ä»»åŠ¡åˆ—è¡¨</h3>
         <div v-if="dayTasks.length === 0" class="text-center py-10 text-gray-500">
             ä»Šæ—¥æ— ä»»åŠ¡ï¼Œè¯·æ·»åŠ æˆ–ä»ä»»åŠ¡åº“ä¸­æ’ç¨‹ã€‚
         </div>

         <div v-for="(task, index) in dayTasks" :key="task.id"
              :data-task-id="task.id"
              :draggable="task.status!=='å·²å®Œæˆ'"
              @dragstart="dragStart(task.id, index)"
              @dragover.prevent
              @drop="dropTask(task.id, index)"
              @dragenter.prevent="$event.target.closest('div.task-item').classList.add('opacity-50')"
              @dragleave.prevent="$event.target.closest('div.task-item').classList.remove('opacity-50')"
              @click="exchangeMode ? clickExchangeTask(task) : openTaskModal('edit', task)"
              class="task-item flex justify-between items-center p-3 rounded mb-2 border hover:shadow-md transition cursor-pointer"
              :class="{'bg-green-50/50 border-green-200 line-through': task.status==='å·²å®Œæˆ', 
                       'bg-white border-gray-200': task.status!=='å·²å®Œæˆ',
                       'conflict-border': task.hasConflict && task.status!=='å·²å®Œæˆ',
                       'cursor-pointer': exchangeMode && task.status!=='å·²å®Œæˆ'}">

             <div class="flex items-center space-x-3 w-1/2">
                 <button @click.stop="toggleTaskStatus(task)" class="text-lg shrink-0">{{ task.status==='å·²å®Œæˆ' ? 'âœ…' : 'â¬œ' }}</button>
                 <div class="text-sm font-medium">
                     <span v-if="task.preId" class="text-xs text-yellow-600 mr-1">[å¤ä¹ å­èŠ‚ç‚¹]</span>
                     <span v-else-if="task.childIds && task.childIds.length > 0" class="text-xs text-indigo-600 mr-1">[å¤ä¹ çˆ¶èŠ‚ç‚¹]</span>
                     {{ task.title }}
                 </div>
             </div>
             
             <div class="flex space-x-4 items-center text-xs text-gray-600">
                 <div class="bg-blue-100 px-2 py-1 rounded shrink-0" v-if="task.startTime && task.duration">
                     â±ï¸ {{ task.startTime }} ({{ task.duration }}m)
                     <span v-if="task.hasConflict" class="text-red-500 ml-1">âš ï¸å†²çª</span>
                 </div>
                 <div v-else class="text-gray-400">
                     (çµæ´»ä»»åŠ¡)
                 </div>
                 <span :class="getPriorityColor(task.priority)" class="w-3 h-3 rounded-full shrink-0"></span>
             </div>
         </div>
    </div>
</div>
            <div v-if="currentView === 'schedule'" class="flex-1 flex flex-col p-4 overflow-hidden">
                
                <div class="bg-white p-3 rounded shadow-sm mb-4 shrink-0 flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <button @click="changeWeek(-1)" class="p-1 hover:bg-gray-100 rounded text-xl">â¬…</button>
                        <div class="text-lg font-bold">
                            {{ dayjs(weekDays[0].date).format('YYYYå¹´MMæœˆDDæ—¥') }} 
                            - 
                            {{ dayjs(weekDays[6].date).format('MMæœˆDDæ—¥') }}
                        </div>
                        <button @click="changeWeek(1)" class="p-1 hover:bg-gray-100 rounded text-xl">â¡</button>
                        <button @click="goToTodayWeek" class="text-xs text-blue-500 underline">å›åˆ°æœ¬å‘¨</button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto bg-white rounded shadow flex">
                    <div class="w-16 shrink-0 bg-gray-50 border-r pt-10 relative">
                        <div v-for="hour in 24" :key="hour" class="hour-slot text-xs text-right pr-2 text-gray-500">
                            {{ hour - 1 < 10 ? '0' : '' }}{{ hour - 1 }}:00
                        </div>
                    </div>

                    <div class="flex-1 grid grid-cols-7 border-collapse relative">
                        <div v-for="day in weekDays" :key="day.date" 
                             class="h-10 text-center border-b border-r sticky top-0 bg-white z-10 p-2"
                             :class="{'bg-blue-100/50': day.date === todayDate}">
                            <div class="text-sm font-bold">{{ day.dayName }}</div>
                            <div class="text-xs" :class="{'text-blue-600 font-bold': day.date === todayDate}">{{ dayjs(day.date).date() }}</div>
                        </div>

                        <div v-for="day in weekDays" :key="'bg-'+day.date" 
                            class="absolute inset-x-0 bottom-0 grid grid-rows-24 border-r"
                            :style="{
                            left: (day.dayIndex * (100 / 7)) + '%', 
                            width: (100 / 7) + '%', 
                            top: '40px',
                            height: 'calc(24 * 60px)'
                            }">
                            <div v-for="h in 24" :key="h" class="border-b border-dotted hour-slot"></div>
                        </div>


                        <template v-for="day in weekDays" :key="'task-col-'+day.date">
                            <div v-if="tasksForWeek[day.date] && tasksForWeek[day.date].filter(t => t.startTime && t.duration).length > 0" 
                                 class="absolute top-10 bottom-0"
                                 :style="{left: (day.dayIndex * (100 / 7)) + '%', width: (100 / 7) + '%'}">
                                
                                <div v-for="task in tasksForWeek[day.date].filter(t => t.startTime && t.duration)" :key="task.id"
                                     class="absolute w-[95%] left-[2.5%] rounded-lg p-1 text-[10px] overflow-hidden cursor-pointer shadow hover:shadow-lg transition z-20"
                                     :class="[getPriorityColor(task.priority).replace('bg', 'bg').replace('500', '100'), getPriorityBorderColor(task.priority).replace('l', 'l'), {'opacity-50 line-through': task.status==='å·²å®Œæˆ'}]"
                                     :style="getTaskPosition(task, true)"
                                     @click="openTaskModal('edit', task)">
                                    
                                    <div class="font-bold text-gray-800">{{ task.title }}</div>
                                    <div class="text-gray-600">{{ task.startTime }} ({{ task.duration }}m)</div>
                                </div>
                            </div>
                        </template>
                        
                        <div v-if="Object.keys(tasksForWeek).length === 0" class="absolute inset-0 flex items-center justify-center text-gray-400">
                            æœ¬å‘¨æš‚æ— æ’ç¨‹ä»»åŠ¡ï¼Œçµæ´»ä»»åŠ¡è¯·åœ¨æ—¥è§†å›¾æˆ–ä»»åŠ¡åº“æŸ¥çœ‹ã€‚
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'habit'" class="flex-1 overflow-y-auto p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">âœ¨ ä¹ æƒ¯å…»æˆ (Habits)</h2>
        <button @click="openHabitModal('create')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded shadow flex items-center">
            <span class="mr-1">+</span> æ–°å»ºä¹ æƒ¯æ¨¡æ¿
        </button>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
        <div v-for="habit in habits" :key="habit.id" 
             class="bg-white rounded-xl shadow-sm hover:shadow-md transition p-5 border-l-4 relative"
             :class="habit.type === 'abstinence' ? 'border-red-500' : 'border-green-500'">
            
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h3 class="font-bold text-lg flex items-center">
                        {{ habit.name }}
                        <span v-if="isTodayARestDay(habit)" class="ml-2 text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">ä¼‘æ¯æ—¥</span>
                    </h3>
                    <div class="text-xs text-gray-500 mt-1">
                        {{ habit.type==='action'?'åšæŒå‹':'æˆ’æ–­å‹' }}
                        <span v-if="habit.breakCycleN > 0" class="ml-2">å‘¨æœŸ: {{ habit.breakCycleN }}å¤©</span>
                    </div>
                </div>
                <div class="flex space-x-1">
                    <button @click="openHabitModal('edit', habit)" class="text-gray-400 hover:text-blue-500 p-1">âœ</button>
                    <button @click="deleteHabit(habit.id)" class="text-gray-400 hover:text-red-500 p-1">ğŸ—‘</button>
                </div>
            </div>

            <p class="text-sm text-gray-600 mb-4 h-10 overflow-hidden text-ellipsis">{{ habit.desc }}</p>
            
            <div class="grid grid-cols-3 gap-2 text-center mb-4">
                <div class="bg-blue-50 p-2 rounded">
                    <div class="text-lg font-bold text-blue-600">{{ habit.stats.currentStreak }}</div>
                    <div class="text-[10px] text-gray-500">å½“å‰è¿ç»­</div>
                </div>
                <div class="bg-green-50 p-2 rounded">
                    <div class="text-lg font-bold text-green-600">{{ calculateRate(habit) }}%</div>
                    <div class="text-[10px] text-gray-500">æ‰“å¡ç‡</div>
                </div>
                <div class="bg-purple-50 p-2 rounded">
                    <div class="text-lg font-bold text-purple-600">{{ habit.stats.maxStreak }}</div>
                    <div class="text-[10px] text-gray-500">æœ€é•¿è¿ç»­</div>
                </div>
            </div>
            
            <!-- ä»Šæ—¥çŠ¶æ€ -->
            <div class="mb-3">
                <div v-if="isTodayARestDay(habit)" class="text-center">
                    <button disabled class="w-full py-2 bg-gray-100 text-gray-500 rounded font-bold cursor-not-allowed">
                        ä»Šæ—¥ä¼‘æ¯ ğŸ›Œ
                    </button>
                    <p class="text-xs text-gray-500 mt-1">ä¼‘æ¯æ—¥ä¸ä¸­æ–­è¿å‡»</p>
                </div>
                <div v-else>
                    <div v-if="isHabitDoneToday(habit)" class="text-center">
                        <button disabled class="w-full py-2 bg-green-100 text-green-700 rounded font-bold cursor-not-allowed">
                            ä»Šæ—¥å·²å®Œæˆ âœ…
                        </button>
                        <p class="text-xs text-green-600 mt-1">å·²æˆåŠŸåšæŒï¼</p>
                    </div>
                    <div v-else>
                        <button @click="checkInHabit(habit)" 
                                class="w-full py-2 rounded font-bold shadow transition"
                                :class="habit.type === 'abstinence' ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'">
                            {{ habit.type === 'abstinence' ? 'æˆ’æ–­æˆåŠŸæ‰“å¡' : 'åšæŒæˆåŠŸæ‰“å¡' }}
                        </button>
                        <p class="text-xs text-gray-500 mt-1 text-center">ç‚¹å‡»è®°å½•ä»Šæ—¥æˆåŠŸ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div v-if="currentView === 'short_term'" class="flex-1 flex flex-col p-6">
    <div class="flex justify-between items-center mb-4 shrink-0">
        <h2 class="text-2xl font-bold text-gray-800">ğŸ“ çŸ­æœŸ & å­¦ä¹ ä»»åŠ¡åº“</h2>
        <button @click="openTaskModal('create', null)" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">+ æ–°å»ºä»»åŠ¡</button>
    </div>
    <div class="bg-white p-3 rounded-lg shadow-sm mb-4 shrink-0">
        <div class="flex items-center space-x-4 text-sm mb-2">
            <label class="font-medium text-gray-700 shrink-0">ç­›é€‰:</label>
            
            <select v-model="shortTermFilterStatus" class="p-1 border rounded text-sm w-32">
                <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                <option value="uncompleted">æœªå®Œæˆ</option>
                <option value="completed">å·²å®Œæˆ</option>
            </select>
            
            <select v-model="shortTermFilterPriority" class="p-1 border rounded text-sm w-32">
                <option value="all">å…¨éƒ¨ä¼˜å…ˆçº§</option>
                <option value="p1">P1 ğŸ”´</option>
                <option value="p2">P2 ğŸŸ¡</option>
                <option value="p3">P3 ğŸ”µ</option>
                <option value="p4">P4 âš«</option>
            </select>
        </div>
        
        <div class="flex items-center space-x-3 text-sm">
            <label class="text-gray-600 shrink-0">è®¡åˆ’æ—¥æœŸèŒƒå›´:</label>
            <div class="flex items-center space-x-2 flex-1">
                <input type="date" v-model="shortTermFilterStartDate" class="p-1 border rounded text-sm w-32">
                <span class="text-gray-500">è‡³</span>
                <input type="date" v-model="shortTermFilterEndDate" class="p-1 border rounded text-sm w-32">
                <button @click="shortTermFilterStartDate=''; shortTermFilterEndDate='';" 
                        class="text-xs text-red-500 hover:text-red-700 underline shrink-0">
                    æ¸…ç©ºæ—¥æœŸ
                </button>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow flex-1 overflow-hidden flex flex-col">
        <div class="h-[500px] overflow-y-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-100 text-gray-600 font-bold sticky top-0">
                    <tr>
                        <th class="p-3">å®Œæˆ</th>
                        <th class="p-3">æ ‡é¢˜</th>
                        <th class="p-3">ä¼˜å…ˆçº§</th>
                        <th class="p-3">è®¡åˆ’æ—¥æœŸ (å¹´/æœˆ/æ—¥)</th>
                        <th class="p-3 text-right">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    <tr v-for="task in filteredShortTasks" :key="task.id" class="hover:bg-gray-50 group">
                        <td class="p-3">
                            <button @click.stop="toggleTaskStatus(task)" class="text-lg shrink-0">
                                {{ task.status==='å·²å®Œæˆ' ? 'âœ…' : 'â¬œ' }}
                            </button>
                        </td>
                        <td class="p-3 font-medium" :class="{'line-through text-gray-500': task.status==='å·²å®Œæˆ'}">
                            {{ task.title }}
                            <span v-if="task.preId" class="text-xs text-yellow-600 ml-1">(å¤ä¹ èŠ‚ç‚¹)</span>
                            <span v-if="task.childIds && task.childIds.length > 0" class="text-xs text-indigo-600 ml-1">(çˆ¶èŠ‚ç‚¹)</span>
                        </td>
                        <td class="p-3"><span :class="getPriorityColor(task.priority)" class="w-3 h-3 rounded-full inline-block mr-1"></span>{{ getPriorityLabel(task.priority) }}</td>
                        <td class="p-3">{{ dayjs(task.plannedDate).format('YYYY-MM-DD') }}</td>
                        <td class="p-3 text-right">
                            <button @click="openTaskModal('edit', task)" class="text-blue-500 hover:underline mr-2">ç¼–è¾‘</button>
                            <button @click="deleteTask(task.id, true)" class="text-red-500 hover:underline">åˆ é™¤</button>
                        </td>
                    </tr>
                    <tr v-if="filteredShortTasks.length===0">
                        <td colspan="5" class="p-8 text-center text-gray-400">æ— ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<div v-if="currentView === 'project'" class="flex-1 flex flex-col p-6 overflow-hidden">
                 <div class="flex justify-between items-center mb-4 shrink-0">
                    <h2 class="text-2xl font-bold text-gray-800">ğŸ— é¡¹ç›®ç®¡ç† (Projects)</h2>
                    <button @click="openProjectModal('create')" class="bg-indigo-600 text-white px-4 py-2 rounded shadow">+ æ–°å»ºé¡¹ç›®</button>
                </div>

                <div class="flex-1 flex space-x-6 overflow-x-auto pb-2">
                    <div v-for="proj in projects" :key="proj.id" class="w-96 flex flex-col bg-white rounded-xl shadow h-full shrink-0 border border-gray-200">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold text-lg truncate">{{ proj.name }}</h3>
                            <div class="flex space-x-1">
                                <button @click="openProjectModal('edit', proj)" class="text-xs text-gray-500 hover:text-blue-500">âš™</button>
                                <button @click="deleteProject(proj.id)" class="text-xs text-gray-500 hover:text-red-500">ğŸ—‘</button>
                            </div>
                        </div>
                        
                        <div class="h-2 bg-gray-200 w-full">
                            <div class="h-full bg-indigo-500 rounded" :style="{width: calculateProjectProgress(proj)+'%'}"></div>
                        </div>
                        <div class="text-xs p-2 text-right text-indigo-600 font-bold">{{ calculateProjectProgress(proj) }}%</div>

                        <div class="flex-1 overflow-y-auto p-3 space-y-4 bg-gray-100">
                            <div v-for="(ms, idx) in proj.milestones" :key="ms.id" class="bg-white p-3 rounded shadow-sm border border-gray-200">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold text-sm text-indigo-700">ğŸ {{ ms.name }}</span>
                                    <button @click="deleteMilestone(proj, ms.id)" class="text-red-400 hover:text-red-600 p-1">ğŸ—‘ï¸</button>
                                </div>
                                
                                <ul class="space-y-1 pl-2 mb-2">
                                    <li v-for="item in ms.contents" :key="item.refId" class="text-xs flex justify-between items-center p-1 hover:bg-gray-50 rounded">
                                        <span class="truncate max-w-[140px]" :class="{'line-through text-gray-400': isItemDone(item)}">
                                            {{ getItemTitle(item) }}
                                        </span>
                                        <div class="flex space-x-1">
                                             <span class="text-[10px] px-1 rounded border" :class="item.type==='habit'?'border-green-200 text-green-600':'border-blue-200 text-blue-600'">
                                                {{ item.type==='habit'?'ä¹ æƒ¯':'ä»»åŠ¡' }}
                                            </span>
                                            <button @click="removeItemFromMilestone(ms, item.refId)" class="text-red-400 hover:text-red-600" title="å–æ¶ˆå…³è”">Ã—</button>
                                        </div>
                                    </li>
                                </ul>

                                <button @click="openMilestoneContentModal(proj, ms)" class="w-full py-1 border border-dashed border-gray-300 text-gray-400 text-xs rounded hover:border-blue-400 hover:text-blue-500">
                                    + æ·»åŠ ä»»åŠ¡/ä¹ æƒ¯
                                </button>
                            </div>

                            <button @click="openMilestoneModal(proj)" class="w-full py-2 bg-white border border-gray-300 text-gray-500 text-sm rounded shadow-sm hover:bg-gray-50">
                                + æ–°å¢é‡Œç¨‹ç¢‘
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="currentView === 'stats'" class="p-6 overflow-y-auto bg-gray-50 flex-1">
                <div class="max-w-6xl mx-auto space-y-6">
                    
                    <div class="flex items-center justify-between mb-2">
                         <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š æ•°æ®æ¦‚è§ˆ</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-4">
                            <div class="p-3 bg-blue-100 text-blue-600 rounded-full text-xl">âœ…</div>
                            <div>
                                <div class="text-sm text-gray-500">æ€»ä»»åŠ¡å®Œæˆ</div>
                                <div class="text-2xl font-bold text-gray-800">{{ overallStats.totalDone }}</div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-4">
                            <div class="p-3 bg-green-100 text-green-600 rounded-full text-xl">ğŸ“ˆ</div>
                            <div>
                                <div class="text-sm text-gray-500">æ€»ä½“å®Œæˆç‡</div>
                                <div class="text-2xl font-bold text-gray-800">{{ overallStats.completionRate }}%</div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-4">
                            <div class="p-3 bg-purple-100 text-purple-600 rounded-full text-xl">âœ¨</div>
                            <div>
                                <div class="text-sm text-gray-500">æ´»è·ƒä¹ æƒ¯æ•°</div>
                                <div class="text-2xl font-bold text-gray-800">{{ overallStats.activeHabits }}</div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-4">
                            <div class="p-3 bg-orange-100 text-orange-600 rounded-full text-xl">ğŸ”¥</div>
                            <div>
                                <div class="text-sm text-gray-500">æœ€é•¿ä¹ æƒ¯è¿å‡»</div>
                                <div class="text-2xl font-bold text-gray-800">{{ overallStats.maxStreak }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg text-gray-700">ğŸ“… å‘¨ä»»åŠ¡è¶‹åŠ¿</h3>
                            <div class="flex items-center space-x-4 text-sm">
                                <button @click="changeStatsWeek(-1)" class="p-1 hover:bg-gray-100 rounded">â¬… ä¸Šå‘¨</button>
                                <span class="font-medium text-gray-600">
                                    {{ dayjs(statsWeekStart).format('YYYYå¹´MMæœˆDDæ—¥') }} - 
                                    {{ dayjs(statsWeekStart).add(6, 'day').format('MMæœˆDDæ—¥') }}
                                </span>
                                <button @click="changeStatsWeek(1)" class="p-1 hover:bg-gray-100 rounded">ä¸‹å‘¨ â¡</button>
                            </div>
                        </div>

                        <div class="h-48 flex items-end justify-between space-x-2 px-4">
                            <div v-for="d in weeklyStatsData" :key="d.date" class="flex-1 flex flex-col items-center group relative">
                                <div class="absolute bottom-full mb-2 hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2 whitespace-nowrap z-10">
                                    {{ d.date }}<br>å®Œæˆ: {{ d.done }} / æ€»è®¡: {{ d.total }}
                                </div>
                                
                                <div class="w-full max-w-[40px] bg-gray-100 rounded-t-lg relative h-32 flex items-end overflow-hidden">
                                    <div class="w-full bg-blue-500 transition-all duration-500 hover:bg-blue-600"
                                         :style="{ height: (d.total > 0 ? (d.done / d.total) * 100 : 0) + '%' }">
                                    </div>
                                    <div class="absolute bottom-0 w-full bg-blue-200 -z-10" 
                                         :style="{ height: (weeklyStatsMax > 0 ? (d.total / weeklyStatsMax) * 100 : 0) + '%' }">
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 mt-2 font-medium">{{ d.dayName }}</div>
                                <div class="text-[10px] text-gray-400">{{ d.done }}/{{ d.total }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg text-gray-700">ğŸ”¥ æ´»è·ƒåº¦çƒ­åŠ›å›¾ </h3>
                            <div class="flex items-center space-x-4 text-sm">
                                <button @click="changeStatsMonth(-1)" class="p-1 hover:bg-gray-100 rounded">â¬… ä¸Šæœˆ</button>
                                <span class="font-medium text-gray-600">{{ dayjs(statsMonthStart).format('YYYYå¹´MMæœˆ') }}</span>
                                <button @click="changeStatsMonth(1)" class="p-1 hover:bg-gray-100 rounded">ä¸‹æœˆ â¡</button>
                            </div>
                        </div>

                        <div class="flex flex-col items-center">
                            <div class="grid grid-cols-7 gap-1 mb-1 w-full max-w-lg">
                                <div v-for="w in ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']" :key="w" class="text-center text-xs text-gray-400 pb-1">{{ w }}</div>
                            </div>
                            <div class="grid grid-cols-7 gap-1 w-full max-w-lg">
                                <div v-for="(day, idx) in monthlyHeatmapData" :key="idx"
                                     class="aspect-square rounded-sm relative group cursor-default"
                                     :class="[day.isEmpty ? 'invisible' : getHeatmapColor(day.count)]">
                                     
                                    <div v-if="!day.isEmpty" class="absolute bottom-full mb-1 hidden group-hover:block bg-black/80 text-white text-xs rounded py-1 px-2 z-20 whitespace-nowrap left-1/2 -translate-x-1/2 pointer-events-none">
                                        {{ day.date }}<br>æ´»è·ƒåº¦: {{ day.count }}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center text-xs text-gray-500 mt-4 space-x-2">
                                <span>Less</span>
                                <div class="w-3 h-3 bg-gray-100 rounded-sm"></div>
                                <div class="w-3 h-3 bg-green-200 rounded-sm"></div>
                                <div class="w-3 h-3 bg-green-400 rounded-sm"></div>
                                <div class="w-3 h-3 bg-green-600 rounded-sm"></div>
                                <span>More</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </main>
    </div>
    <nav class="h-16 bg-gray-800 flex justify-around items-center text-gray-400 shrink-0 w-full shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-40">
        <div v-for="nav in compactNavs" :key="nav.key" 
             @click="currentView = nav.subKeys ? nav.subKeys[0] : nav.key"
             class="flex flex-col items-center justify-center cursor-pointer hover:text-white transition group relative h-full w-full"
             :class="{'text-blue-400': nav.subKeys ? nav.subKeys.includes(currentView) : currentView === nav.key}">
            <span class="text-xl mb-0.5">{{ nav.icon }}</span>
            <span class="text-[10px]">{{ nav.label }}</span>
            <div v-if="nav.subKeys ? nav.subKeys.includes(currentView) : currentView === nav.key" class="absolute top-0 left-0 right-0 h-1 bg-blue-400"></div>
        </div>
    </nav>
    <div v-if="showHabitModal" class="fixed inset-0 bg-black/50 modal-bg flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md modal-content" @click.stop>
        <h3 class="text-xl font-bold mb-4">{{ modalMode==='create'?'æ–°å»ºä¹ æƒ¯æ¨¡æ¿':'ç¼–è¾‘ä¹ æƒ¯æ¨¡æ¿' }}</h3>
        <label class="block mb-2 text-sm font-medium">åç§°</label>
        <input type="text" v-model="editingHabit.name" class="w-full p-2 border rounded mb-4">
        <label class="block mb-2 text-sm font-medium">ç±»å‹</label>
        <select v-model="editingHabit.type" class="w-full p-2 border rounded mb-4">
            <option value="action">åšæŒå‹ (Action)</option>
            <option value="abstinence">æˆ’æ–­å‹ (Abstinence)</option>
        </select>
        <label class="block mb-2 text-sm font-medium">æè¿°</label>
        <textarea v-model="editingHabit.desc" class="w-full p-2 border rounded mb-4"></textarea>
        <label class="block mb-2 text-sm font-medium">é»˜è®¤å¼€å§‹æ—¶é—´ (ä»…ç”¨äºåšæŒå‹)</label>
        <input type="time" v-model="editingHabit.defaultTime" class="w-full p-2 border rounded mb-4" :disabled="editingHabit.type === 'abstinence'">

        <hr class="my-4">
        <h4 class="font-bold text-gray-700 mb-2">ä¼‘æ¯ç­–ç•¥ (ä¼‘æ¯æ—¥ä¸ç”Ÿæˆä»»åŠ¡/ä¸ä¸­æ–­è¿å‡»)</h4>
        <label class="block mb-2 text-sm font-medium">ä¼‘æ¯å‘¨æœŸ N (å¤©)</label>
        <input type="number" v-model.number="editingHabit.breakCycleN" min="1" class="w-full p-2 border rounded mb-4" @change="editingHabit.breakDays = []">
        
        <div v-if="editingHabit.breakCycleN === 7">
            <label class="block mb-2 text-sm font-medium">å‘¨æœŸå†…ä¼‘æ¯æ—¥</label>
            <div class="flex flex-wrap gap-2 mb-4">
                <label v-for="(dayName, index) in ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­']" 
                       :key="index"
                       class="flex items-center space-x-1 cursor-pointer">
                    <input type="checkbox" 
                           :value="index" 
                           v-model="editingHabit.breakDays" 
                           class="rounded text-purple-600 focus:ring-purple-500">
                    <span class="text-sm">{{ dayName }}</span>
                </label>
            </div>
        </div>
        <div v-else-if="editingHabit.breakCycleN > 0">
            <label class="block mb-2 text-sm font-medium">ä¼‘æ¯æ—¥ (é€‰æ‹©å‘¨æœŸå†…çš„ç¬¬å‡ å¤©)</label>
            <div class="flex flex-wrap gap-2 mb-4">
                <button 
                    v-for="n in editingHabit.breakCycleN" 
                    :key="n"
                    @click="toggleBreakDay(n)"
                    type="button"
                    class="px-3 py-1 text-sm rounded border transition"
                    :class="editingHabit.breakDays.includes(n) ? 
                           'bg-purple-600 text-white border-purple-700' : 
                           'bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200'">
                    ç¬¬{{ n }}å¤©
                </button>
            </div>
            <div class="text-xs text-gray-500 mt-2">
                å·²é€‰æ‹©: {{ editingHabit.breakDays.sort((a,b)=>a-b).join(', ') }}
            </div>
        </div>
        <div v-else class="text-sm text-gray-500 mb-4">
            è¯·è¾“å…¥æœ‰æ•ˆçš„ä¼‘æ¯å‘¨æœŸ (N)ã€‚
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button @click="showHabitModal=false" class="px-4 py-2 border rounded">å–æ¶ˆ</button>
            <button @click="saveHabit" class="px-4 py-2 bg-purple-600 text-white rounded">ä¿å­˜</button>
        </div>
    </div>
</div>

    <div v-if="showTaskModal" class="fixed inset-0 bg-black/50 modal-bg flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-lg modal-content" @click.stop>
            <h3 class="text-xl font-bold mb-4">{{ modalMode==='create'?'æ–°å»ºä»»åŠ¡':'ç¼–è¾‘ä»»åŠ¡' }}</h3>
            <label class="block mb-2 text-sm font-medium">æ ‡é¢˜</label>
            <input type="text" v-model="editingTask.title" class="w-full p-2 border rounded mb-4">
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block mb-2 text-sm font-medium">ç±»å‹</label>
                    <select v-model="editingTask.type" class="w-full p-2 border rounded">
                        <option value="å·¥ä½œ">å·¥ä½œ</option><option value="å­¦ä¹ ">å­¦ä¹ </option><option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
                        <option value="ä¹ æƒ¯">ä¹ æƒ¯</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">ä¼˜å…ˆçº§</label>
                    <select v-model="editingTask.priority" class="w-full p-2 border rounded">
                        <option value="p1">P1 (ç´§æ€¥)</option><option value="p2">P2 (é‡è¦)</option>
                        <option value="p3">P3 (æ—¥å¸¸)</option><option value="p4">P4 (å¾…åŠ)</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">è®¡åˆ’æ—¥æœŸ</label>
                    <input type="date" v-model="editingTask.plannedDate" class="w-full p-2 border rounded">
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block mb-2 text-sm font-medium">å¼€å§‹æ—¶é—´ (å¯é€‰)</label>
                    <input type="time" v-model="editingTask.startTime" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">æŒç»­æ—¶é•¿ (åˆ†é’Ÿ)</label>
                    <input type="number" v-model.number="editingTask.duration" class="w-full p-2 border rounded">
                </div>
                <div class="flex items-center pt-8">
                    </div>
            </div>
            <div v-if="editingTask.type === 'å­¦ä¹ ' && !editingTask.preId" class="p-4 border rounded bg-yellow-50 mb-4">
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="review" v-model="editingTask.isReviewTask" class="mr-2">
                    <label for="review" class="text-sm font-bold">ç”Ÿæˆå¤ä¹ é“¾è¡¨ (Spaced Repetition)</label>
                </div>
                <div v-if="editingTask.isReviewTask" class="mt-2">
                    <label class="block mb-2 text-sm font-medium">å¤ä¹ ç­–ç•¥ (é€—å·åˆ†éš”å¤©æ•°ï¼Œå¦‚ 1, 3, 7)</label>
                    <input type="text" v-model="editingTask.customIntervals" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤: 1, 2, 4, 7, 15, 30" class="w-full p-2 border rounded">
                    <p class="text-xs text-gray-500 mt-1">æ³¨æ„ï¼šä¿å­˜åå°†ç”Ÿæˆä¸€ç³»åˆ—å­ä»»åŠ¡ã€‚</p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button @click="showTaskModal=false" class="px-4 py-2 border rounded">å–æ¶ˆ</button>
                <button @click="saveTask" class="px-4 py-2 bg-blue-600 text-white rounded">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div v-if="showProjectModal" class="fixed inset-0 bg-black/50 modal-bg flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md modal-content" @click.stop>
            <h3 class="text-xl font-bold mb-4">{{ modalMode==='create'?'æ–°å»ºé¡¹ç›®':'ç¼–è¾‘é¡¹ç›®' }}</h3>
            <label class="block mb-2 text-sm font-medium">é¡¹ç›®åç§°</label>
            <input type="text" v-model="editingProject.name" class="w-full p-2 border rounded mb-4">
            <div class="flex justify-end space-x-3 mt-6">
                <button @click="showProjectModal=false" class="px-4 py-2 border rounded">å–æ¶ˆ</button>
                <button @click="saveProject" class="px-4 py-2 bg-indigo-600 text-white rounded">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div v-if="showMilestoneModal" class="fixed inset-0 bg-black/50 modal-bg flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md modal-content" @click.stop>
            <h3 class="text-xl font-bold mb-4">æ–°å¢é‡Œç¨‹ç¢‘åˆ°: {{ currentProject.name }}</h3>
            <label class="block mb-2 text-sm font-medium">é‡Œç¨‹ç¢‘åç§°</label>
            <input type="text" v-model="editingMilestone.name" class="w-full p-2 border rounded mb-4">
            <div class="flex justify-end space-x-3 mt-6">
                <button @click="showMilestoneModal=false" class="px-4 py-2 border rounded">å–æ¶ˆ</button>
                <button @click="saveMilestone" class="px-4 py-2 bg-indigo-600 text-white rounded">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div v-if="showMilestoneContentModal" class="fixed inset-0 bg-black/50 modal-bg flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md modal-content" @click.stop>
            <h3 class="text-xl font-bold mb-4">å…³è”ä»»åŠ¡/ä¹ æƒ¯åˆ°: {{ currentProject.name }} - {{ currentMilestone.name }}</h3>
            
            <div class="flex space-x-4 border-b mb-4">
                <button @click="milestoneTab='task'" 
                        :class="{'border-b-2 border-blue-500 text-blue-600 font-bold': milestoneTab==='task'}"
                        class="pb-1 text-sm text-gray-600 hover:text-blue-600 transition">
                    å…³è”ä»»åŠ¡
                </button>
                <button @click="milestoneTab='habit'" 
                        :class="{'border-b-2 border-blue-500 text-blue-600 font-bold': milestoneTab==='habit'}"
                        class="pb-1 text-sm text-gray-600 hover:text-blue-600 transition">
                    å…³è”ä¹ æƒ¯
                </button>
            </div>
            
            <div class="h-80 overflow-y-auto space-y-2">
                <div v-if="milestoneTab==='task'">
                    <div v-for="task in allTasks" :key="task.id" class="flex justify-between items-center p-2 border rounded hover:bg-gray-50">
                        <span class="text-sm truncate">{{ task.title }}</span>
                        <button @click="addToMilestone('task', task.id)" 
                                :disabled="isItemInMilestone(currentMilestone, task.id)"
                                class="text-xs px-2 py-1 rounded" 
                                :class="isItemInMilestone(currentMilestone, task.id)?'bg-gray-200 text-gray-500':'bg-blue-500 text-white hover:bg-blue-600'">
                            {{ isItemInMilestone(currentMilestone, task.id)?'å·²å…³è”':'å…³è”' }}
                        </button>
                    </div>
                </div>
                <div v-if="milestoneTab==='habit'">
                    <div v-for="habit in habits" :key="habit.id" class="flex justify-between items-center p-2 border rounded hover:bg-gray-50">
                        <span class="text-sm truncate">{{ habit.name }}</span>
                        <button @click="addToMilestone('habit', habit.id)" 
                                :disabled="isItemInMilestone(currentMilestone, habit.id)"
                                class="text-xs px-2 py-1 rounded" 
                                :class="isItemInMilestone(currentMilestone, habit.id)?'bg-gray-200 text-gray-500':'bg-blue-500 text-white hover:bg-blue-600'">
                            {{ isItemInMilestone(currentMilestone, habit.id)?'å·²å…³è”':'å…³è”' }}
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button @click="showMilestoneContentModal=false" class="px-4 py-2 border rounded">å…³é—­</button>
            </div>
        </div>
    </div>
<div v-if="showCloudSyncModal" class="fixed inset-0 bg-black/50 modal-bg flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md modal-content" @click.stop>
        <h3 class="text-xl font-bold mb-4">â˜ï¸ äº‘ç«¯åŒæ­¥</h3>
        
        <div class="mb-4">
            <label class="block mb-2 text-sm font-medium">åŒæ­¥å¯†ç </label>
            <input type="password" v-model="cloudPassword" 
                   placeholder="è¾“å…¥åŒæ­¥å¯†ç ï¼ˆ6ä½ä»¥ä¸Šï¼‰"
                   class="w-full p-2 border rounded mb-2">
            <p class="text-xs text-gray-500">è¯·è®°ä½æ­¤å¯†ç ï¼Œç”¨äºäº‘ç«¯æ•°æ®è®¿é—®</p>
        </div>
        
        <div class="mb-4">
            <label class="block mb-2 text-sm font-medium">äº‘ç«¯æ“ä½œ</label>
            <div class="space-y-2">
                <button @click="uploadToCloud" 
                        class="w-full py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                    ğŸ“¤ ä¸Šä¼ åˆ°äº‘ç«¯
                </button>
                <button @click="downloadFromCloud" 
                        class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    ğŸ“¥ ä»äº‘ç«¯ä¸‹è½½
                </button>
                <button @click="checkCloudStatus" 
                        class="w-full py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                    ğŸ” æ£€æŸ¥äº‘ç«¯çŠ¶æ€
                </button>
            </div>
        </div>
        
        <div v-if="cloudMessage" class="p-3 rounded mb-4 text-sm" 
             :class="cloudMessageType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
            {{ cloudMessage }}
        </div>
        
        <div v-if="lastSyncTime" class="text-xs text-gray-500 mb-4">
            æœ€ååŒæ­¥: {{ dayjs(lastSyncTime).format('YYYY-MM-DD HH:mm') }}
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
            <button @click="showCloudSyncModal=false; cloudMessage=''" 
                    class="px-4 py-2 border rounded">å…³é—­</button>
        </div>
    </div>
</div>
</div>

<script>
    const { ref, computed, watch, onMounted } = Vue;
    const generateUniqueId = (prefix = 'id_') => {
        return prefix + Date.now().toString(36) + Math.random().toString(36).substring(2);
    };

    const getPriorityColor = (priority) => {
        switch (priority) {
            case 'p1': return 'bg-red-500';
            case 'p2': return 'bg-yellow-500';
            case 'p3': return 'bg-blue-500';
            case 'p4': return 'bg-gray-500';
            default: return 'bg-gray-400';
        }
    };
    const getPriorityBorderColor = (priority) => {
        switch (priority) {
            case 'p1': return 'border-l-red-500';
            case 'p2': return 'border-l-yellow-500';
            case 'p3': return 'border-l-blue-500';
            case 'p4': return 'border-l-gray-500';
            default: return 'border-l-gray-400';
        }
    };
    const getPriorityLabel = (priority) => {
        switch (priority) {
            case 'p1': return 'P1 (ç´§æ€¥)';
            case 'p2': return 'P2 (é‡è¦)';
            case 'p3': return 'P3 (æ—¥å¸¸)';
            case 'p4': return 'P4 (å¾…åŠ)';
            default: return 'æœªçŸ¥';
        }
    };
    
    const getTaskEnd = (task) => {
        if (!task.startTime || !task.duration) return null;
        const start = dayjs(task.plannedDate + ' ' + task.startTime);
        return start.add(task.duration, 'minute');
    };
    
    // --- Vue App Setup ---
    Vue.createApp({
        setup() {
            // --- çŠ¶æ€ä¸æ•°æ®å®šä¹‰ ---
            const currentView = ref('day'); 
            const tasks = ref([]); 
            const habits = ref([]);
            const projects = ref([]);
            const exchangeMode = ref(false);
            const taskToExchange = ref(null);
            const appSettings = {
                defaultReviewIntervals: [1, 2, 4, 7, 15, 30] // é»˜è®¤å¤ä¹ é—´éš”ï¼ˆå¤©ï¼‰
            };
            const supabaseUrl ='https://forssiunltppioadnzgv.supabase.co'
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvcnNzaXVubHRwcGlvYWRuemd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzAxMzMsImV4cCI6MjA4MTA0NjEzM30.EgGF5aUiCKXRBwEh-pdLmT7hYKd7PFmz-YMW14x7CiA'
            const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            const showCloudSyncModal = ref(false);
            const cloudPassword = ref('');
            const cloudMessage = ref('');
            const cloudMessageType = ref(''); // 'success' æˆ– 'error'
            const lastSyncTime = ref(localStorage.getItem('lastCloudSyncTime') || null);
            const isSyncing = ref(false);
            const CLOUD_TABLE_NAME = 'life_os_data';
            const initCloudTable = async () => {
    try {
        // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        const { error } = await supabase
            .from(CLOUD_TABLE_NAME)
            .select('id')
            .limit(1);
            
        if (error && error.code === '42P01') { // è¡¨ä¸å­˜åœ¨
            console.log('äº‘ç«¯è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦åœ¨ Supabase æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»º');
            console.log(`è¯·åˆ›å»ºè¡¨ ${CLOUD_TABLE_NAME}ï¼ŒåŒ…å«å­—æ®µï¼šid, user_id, data, created_at, updated_at`);
        }
    } catch (error) {
        console.error('åˆå§‹åŒ–äº‘ç«¯è¡¨å¤±è´¥:', error);
    }
};

// æ‰“å¼€äº‘ç«¯åŒæ­¥æ¨¡æ€æ¡†
const openCloudSyncModal = () => {
    showCloudSyncModal.value = true;
    cloudMessage.value = '';
    cloudPassword.value = localStorage.getItem('cloudPassword') || '';
};

// æ£€æŸ¥äº‘ç«¯çŠ¶æ€
const checkCloudStatus = async () => {
    if (!cloudPassword.value) {
        cloudMessage.value = 'è¯·å…ˆè¾“å…¥åŒæ­¥å¯†ç ';
        cloudMessageType.value = 'error';
        return;
    }
    
    try {
        isSyncing.value = true;
        cloudMessage.value = 'æ£€æŸ¥äº‘ç«¯çŠ¶æ€ä¸­...';
        
        const { data, error } = await supabase
            .from(CLOUD_TABLE_NAME)
            .select('updated_at')
            .eq('user_id', cloudPassword.value)
            .single();
            
        if (error) {
            if (error.code === 'PGRST116') {
                cloudMessage.value = 'äº‘ç«¯æš‚æ— æ•°æ®';
                cloudMessageType.value = 'success';
            } else {
                throw error;
            }
        } else {
            cloudMessage.value = `äº‘ç«¯æœ‰æ•°æ®ï¼Œæœ€åæ›´æ–°: ${dayjs(data.updated_at).format('YYYY-MM-DD HH:mm')}`;
            cloudMessageType.value = 'success';
        }
    } catch (error) {
        console.error('æ£€æŸ¥äº‘ç«¯çŠ¶æ€å¤±è´¥:', error);
        cloudMessage.value = `æ£€æŸ¥å¤±è´¥: ${error.message}`;
        cloudMessageType.value = 'error';
    } finally {
        isSyncing.value = false;
    }
};

// ä¸Šä¼ åˆ°äº‘ç«¯
const uploadToCloud = async () => {
    if (!cloudPassword.value || cloudPassword.value.length < 6) {
        cloudMessage.value = 'å¯†ç è‡³å°‘éœ€è¦6ä½';
        cloudMessageType.value = 'error';
        return;
    }
    
    if (!confirm('ç¡®å®šä¸Šä¼ å½“å‰æ•°æ®åˆ°äº‘ç«¯å—ï¼Ÿè¿™ä¼šè¦†ç›–äº‘ç«¯ç°æœ‰æ•°æ®ã€‚')) {
        return;
    }
    
    try {
        isSyncing.value = true;
        cloudMessage.value = 'ä¸Šä¼ ä¸­...';
        
        // å‡†å¤‡æ•°æ®
        const dataToUpload = {
            tasks: tasks.value,
            habits: habits.value,
            projects: projects.value,
            appSettings: appSettings
        };
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const { data: existingData } = await supabase
            .from(CLOUD_TABLE_NAME)
            .select('id')
            .eq('user_id', cloudPassword.value)
            .single();
        
        const now = new Date().toISOString();
        
        if (existingData) {
            // æ›´æ–°ç°æœ‰è®°å½•
            const { error } = await supabase
                .from(CLOUD_TABLE_NAME)
                .update({
                    data: dataToUpload,
                    updated_at: now
                })
                .eq('user_id', cloudPassword.value);
                
            if (error) throw error;
            cloudMessage.value = 'äº‘ç«¯æ•°æ®å·²æ›´æ–°';
        } else {
            // åˆ›å»ºæ–°è®°å½•
            const { error } = await supabase
                .from(CLOUD_TABLE_NAME)
                .insert({
                    user_id: cloudPassword.value,
                    data: dataToUpload,
                    created_at: now,
                    updated_at: now
                });
                
            if (error) throw error;
            cloudMessage.value = 'æ•°æ®å·²æˆåŠŸä¸Šä¼ åˆ°äº‘ç«¯';
        }
        
        cloudMessageType.value = 'success';
        lastSyncTime.value = now;
        localStorage.setItem('lastCloudSyncTime', now);
        localStorage.setItem('cloudPassword', cloudPassword.value);
        
        // ä¿å­˜å¯†ç åˆ°æœ¬åœ°
        saveData();
        
    } catch (error) {
        console.error('ä¸Šä¼ åˆ°äº‘ç«¯å¤±è´¥:', error);
        cloudMessage.value = `ä¸Šä¼ å¤±è´¥: ${error.message}`;
        cloudMessageType.value = 'error';
    } finally {
        isSyncing.value = false;
    }
};

// ä»äº‘ç«¯ä¸‹è½½
const downloadFromCloud = async () => {
    if (!cloudPassword.value) {
        cloudMessage.value = 'è¯·å…ˆè¾“å…¥åŒæ­¥å¯†ç ';
        cloudMessageType.value = 'error';
        return;
    }
    
    if (!confirm('ç¡®å®šä»äº‘ç«¯ä¸‹è½½æ•°æ®å—ï¼Ÿè¿™ä¼šè¦†ç›–æœ¬åœ°æ‰€æœ‰æ•°æ®ã€‚')) {
        return;
    }
    
    try {
        isSyncing.value = true;
        cloudMessage.value = 'ä¸‹è½½ä¸­...';
        
        const { data, error } = await supabase
            .from(CLOUD_TABLE_NAME)
            .select('data, updated_at')
            .eq('user_id', cloudPassword.value)
            .single();
            
        if (error) {
            if (error.code === 'PGRST116') {
                cloudMessage.value = 'äº‘ç«¯æ²¡æœ‰æ‰¾åˆ°æ•°æ®ï¼Œè¯·æ£€æŸ¥å¯†ç ';
                cloudMessageType.value = 'error';
            } else {
                throw error;
            }
            return;
        }
        
        if (data && data.data) {
            // è¦†ç›–æœ¬åœ°æ•°æ®
            tasks.value = data.data.tasks || [];
            habits.value = data.data.habits || [];
            projects.value = data.data.projects || [];
            Object.assign(appSettings, data.data.appSettings || {});
            
            // ç¡®ä¿æ•°æ®ç»“æ„
            tasks.value.forEach(t => {
                if (!t.childIds) t.childIds = [];
                if (!t.preId) t.preId = null;
            });
            
            habits.value.forEach(h => {
                if (h.breakCycleN === undefined) h.breakCycleN = 7;
                if (h.breakDays === undefined) h.breakDays = [];
            });
            
            projects.value.forEach(p => {
                if (!p.milestones) p.milestones = [];
                p.milestones.forEach(ms => {
                    if (!ms.contents) ms.contents = [];
                });
            });
            
            // å¯¼å…¥åé‡æ–°æ£€æŸ¥ä¹ æƒ¯ç”Ÿæˆ
            checkDailyHabitGeneration(true);
            saveData();
            
            cloudMessage.value = 'æ•°æ®å·²æˆåŠŸä»äº‘ç«¯ä¸‹è½½';
            cloudMessageType.value = 'success';
            lastSyncTime.value = data.updated_at;
            localStorage.setItem('lastCloudSyncTime', data.updated_at);
            localStorage.setItem('cloudPassword', cloudPassword.value);
            
            // æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡
            const taskCount = tasks.value.length;
            const habitCount = habits.value.length;
            const projectCount = projects.value.length;
            cloudMessage.value += ` (${taskCount}ä»»åŠ¡, ${habitCount}ä¹ æƒ¯, ${projectCount}é¡¹ç›®)`;
        }
    } catch (error) {
        console.error('ä»äº‘ç«¯ä¸‹è½½å¤±è´¥:', error);
        cloudMessage.value = `ä¸‹è½½å¤±è´¥: ${error.message}`;
        cloudMessageType.value = 'error';
    } finally {
        isSyncing.value = false;
    }
};
const autoBackupToCloud = async () => {
    const lastBackup = localStorage.getItem('lastAutoBackup');
    const today = dayjs().format('YYYY-MM-DD');
    
    if (lastBackup !== today && cloudPassword.value) {
        try {
            await uploadToCloud();
            localStorage.setItem('lastAutoBackup', today);
            console.log('è‡ªåŠ¨å¤‡ä»½å®Œæˆ');
        } catch (error) {
            console.error('è‡ªåŠ¨å¤‡ä»½å¤±è´¥:', error);
        }
    }
};
// åœ¨ onMounted ä¸­æ·»åŠ åˆå§‹åŒ–
onMounted(() => {
    loadData();
    checkDailyHabitGeneration();
    initCloudTable();
    autoBackupToCloud();
});
            // æ—¥å†/æ—¶é—´ç›¸å…³
            const todayDate = dayjs().format('YYYY-MM-DD');
            const selectedDate = ref(todayDate);
            const selectedWeekStart = ref(dayjs().weekday(0).format('YYYY-MM-DD')); // å‘¨ä¸€
            const selectedMonthStart = ref(dayjs().startOf('month').format('YYYY-MM-DD'));
            
            // ç»Ÿè®¡è§†å›¾çŠ¶æ€
            const statsWeekStart = ref(dayjs().weekday(0).format('YYYY-MM-DD'));
            const statsMonthStart = ref(dayjs().startOf('month').format('YYYY-MM-DD'));

            // ä»»åŠ¡æ‹–æ‹½ç›¸å…³
            const draggedTask = ref(null);
            const dragMode = ref(null); // 'move'
            
            // æ¨¡æ€æ¡†ç›¸å…³
            const showHabitModal = ref(false);
            const showTaskModal = ref(false);
            const showProjectModal = ref(false);
            const showMilestoneModal = ref(false);
            const showMilestoneContentModal = ref(false);

            const modalMode = ref('create'); // 'create' or 'edit'
            const editingHabit = ref({});
            const editingTask = ref({});
            const editingProject = ref({});
            const editingMilestone = ref({});
            const originalEditingTask = ref(null); // ç”¨äºå¤ä¹ é“¾è¡¨æ—¶é—´ä¿®æ”¹çš„åˆ¤æ–­
            
            // é¡¹ç›®/é‡Œç¨‹ç¢‘å…³è”
            const currentProject = ref(null);
            const currentMilestone = ref(null);
            const milestoneTab = ref('task'); // 'task' or 'habit'

            // æ—¥è§†å›¾ä¼˜å…ˆçº§ç­›é€‰
            const selectedPriorityFilter = ref('all'); 
            
            const shortTermFilterStatus = ref('all'); // 'all', 'completed', 'uncompleted'
            const shortTermFilterPriority = ref('all'); // 'all', 'p1', 'p2', 'p3', 'p4'
            const shortTermFilterStartDate = ref(''); // YYYY-MM-DD
            const shortTermFilterEndDate = ref('');   // YYYY-MM-DD

            const fileInput = ref(null);

            const compactNavs = [
                { key: 'schedule', label: 'æ—¥ç¨‹', icon: 'ğŸ ', subKeys: ['day', 'schedule', 'month'] },
                { key: 'short_term', label: 'ä»»åŠ¡', icon: 'ğŸ“' },
                { key: 'habit', label: 'ä¹ æƒ¯', icon: 'âœ¨' },
                { key: 'project', label: 'é¡¹ç›®', icon: 'ğŸ—' },
                { key: 'stats', label: 'ç»Ÿè®¡', icon: 'ğŸ“Š' }
            ];

            const saveData = () => {
                localStorage.setItem('lifeOsPro_v2', JSON.stringify({ tasks: tasks.value, habits: habits.value, projects: projects.value, appSettings }));
            };
            
            const loadData = () => {
                const raw = localStorage.getItem('lifeOsPro_v2');
                if(raw) {
                    const d = JSON.parse(raw);
                    tasks.value = d.tasks || [];
                    habits.value = d.habits || [];
                    projects.value = d.projects || [];
                    Object.assign(appSettings, d.appSettings);
                }
                // ç¡®ä¿æ•°æ®ç»“æ„å…¼å®¹ childIds, preId, ä»¥åŠæ–°å¢çš„ä¹ æƒ¯å±æ€§
                tasks.value.forEach(t => {
                    if (!t.childIds) t.childIds = [];
                    if (!t.preId) t.preId = null;
                });
                habits.value.forEach(h => {
                    if (h.breakCycleN === undefined) h.breakCycleN = 7;
                    if (h.breakDays === undefined) h.breakDays = [];
                    if (!h.dateRange) h.dateRange = { start: todayDate, end: dayjs().add(1,'year').format('YYYY-MM-DD') };
                });
                // ç¡®ä¿é¡¹ç›®ä¸­çš„é‡Œç¨‹ç¢‘å†…å®¹æ•°ç»„å­˜åœ¨ï¼Œé˜²æ­¢æ¸²æŸ“æ—¶å‡ºç° 'length' undefined é”™è¯¯
                projects.value.forEach(p => {
                    if (!p.milestones) p.milestones = [];
                    p.milestones.forEach(ms => {
                        if (!ms.contents) {
                            ms.contents = [];
                        }
                    });
                });
            };

            const checkDailyHabitGeneration = (forceToday = false) => {
                const today = dayjs().format('YYYY-MM-DD');
                const lastCheckDate = localStorage.getItem('lastHabitCheckDate');

                if (lastCheckDate === today && !forceToday) return;

                habits.value.forEach(h => {
                    if (h.type === 'action' && h.defaultTime && h.duration > 0 && h.active) {
                        const existingTask = tasks.value.some(t => t.plannedDate === today && t.habitId === h.id && t.isGeneratedFromHabit );
                        if (existingTask) return; // å·²ç”Ÿæˆï¼Œè·³è¿‡
                        if (isTodayARestDay(h)) {
                            console.log(`[Habit Gen] ${h.name} is a rest day. No task generated.`);
                            return;
                        }
                        tasks.value.push({
                            id: generateUniqueId('t_'),
                            title: `[æ¯æ—¥] ${h.name}`,
                            type: 'ä¹ æƒ¯',
                            priority: 'p3',
                            plannedDate: today,
                            startTime: h.defaultTime,
                            duration: h.duration,
                            status: 'æœªå¼€å§‹',
                            habitId: h.id, // å…³è” ID
                            isGeneratedFromHabit: true,
                            childIds: [],
                            preId: null,
                            hasConflict: false
                        });
                    }
                });
                localStorage.setItem('lastHabitCheckDate', today);
            };


            onMounted(() => {
                loadData();
                checkDailyHabitGeneration();
            });

            watch([tasks, habits, projects], saveData, { deep: true });

            // --- å¯¼å…¥/å¯¼å‡º ---
            const exportData = () => {
                const data = JSON.stringify({ tasks: tasks.value, habits: habits.value, projects: projects.value, appSettings }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `LifeOS_Pro_backup_${dayjs().format('YYYYMMDD')}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('æ•°æ®å·²å¯¼å‡ºï¼');
            };
            const triggerImport = () => {
                fileInput.value.click();
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (res) => {
                    try {
                        const importedData = JSON.parse(res.target.result);
                        if (confirm("ç¡®å®šå¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼")) {
                            tasks.value = importedData.tasks || [];
                            habits.value = importedData.habits || [];
                            projects.value = importedData.projects || [];
                            Object.assign(appSettings, importedData.appSettings || {});
                            // å¯¼å…¥åé‡æ–°æ£€æŸ¥ä¹ æƒ¯ç”Ÿæˆï¼ˆé˜²æ­¢ä¸¢å¤±å½“å¤©çš„ï¼‰
                            checkDailyHabitGeneration(true); 
                            saveData();
                            alert("æ•°æ®å¯¼å…¥æˆåŠŸï¼");
                        }
                    } catch (error) {
                        alert("æ•°æ®å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼");
                        console.error("Import error:", error);
                    }
                };
                reader.readAsText(file);
            };

            // --- æ—¥æœŸ/å‘¨è§†å›¾è®¡ç®— ---
            const getWeekDay = (date) => dayjs(date).format('dddd');
            const changeDate = (off) => {
                selectedDate.value = dayjs(selectedDate.value).add(off, 'day').format('YYYY-MM-DD');
            };
            const changeWeek = (off) => {
                selectedWeekStart.value = dayjs(selectedWeekStart.value).add(off, 'week').weekday(0).format('YYYY-MM-DD');
            };
            const goToTodayWeek = () => {
                selectedWeekStart.value = dayjs().weekday(0).format('YYYY-MM-DD');
            };
            const weekDays = computed(() => {
                const start = dayjs(selectedWeekStart.value);
                const days = [];
                for (let i = 0; i < 7; i++) {
                    const date = start.add(i, 'day').format('YYYY-MM-DD');
                    days.push({
                        date: date,
                        dayName: getWeekDay(date),
                        dayIndex: i 
                    });
                }
                return days;
            });

            // --- ä»»åŠ¡æ’ç¨‹ (æ—¶é—´å†²çªæ£€æµ‹ã€å½“æ—¥ä»»åŠ¡åˆ—è¡¨) ---
            const toggleExchangeMode = () => {
    exchangeMode.value = !exchangeMode.value;
    taskToExchange.value = null;
    if (!exchangeMode.value) {
        // é€€å‡ºäº¤æ¢æ¨¡å¼æ—¶ï¼Œç§»é™¤æ‰€æœ‰ä»»åŠ¡çš„é«˜äº®æ ·å¼
        document.querySelectorAll('.task-item').forEach(el => {
            el.classList.remove('bg-yellow-100', 'border-yellow-400', 'ring-2', 'ring-yellow-300');
        });
    }
};

// ç‚¹å‡»ä»»åŠ¡è¿›è¡Œäº¤æ¢
const clickExchangeTask = (task) => {
    if (!exchangeMode.value || task.status === 'å·²å®Œæˆ') return;
    
    if (!taskToExchange.value) {
        // é€‰æ‹©ç¬¬ä¸€ä¸ªä»»åŠ¡
        taskToExchange.value = task;
        // é«˜äº®æ˜¾ç¤ºé€‰ä¸­çš„ä»»åŠ¡
        const taskElement = document.querySelector(`[data-task-id="${task.id}"]`);
        if (taskElement) {
            taskElement.classList.add('bg-yellow-100', 'border-yellow-400', 'ring-2', 'ring-yellow-300');
        }
    } else {
        // é€‰æ‹©ç¬¬äºŒä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œäº¤æ¢
        if (taskToExchange.value.id === task.id) {
            alert('ä¸èƒ½é€‰æ‹©åŒä¸€ä¸ªä»»åŠ¡è¿›è¡Œäº¤æ¢');
            return;
        }
        
        // æ‰§è¡Œæ—¶é—´äº¤æ¢é€»è¾‘
        const firstTaskRef = tasks.value.find(t => t.id === taskToExchange.value.id);
        const secondTaskRef = tasks.value.find(t => t.id === task.id);
        
        if (!firstTaskRef || !secondTaskRef) return;
        
        const tempTime = firstTaskRef.startTime;
        const tempDuration = firstTaskRef.duration;
        
        firstTaskRef.startTime = secondTaskRef.startTime;
        firstTaskRef.duration = secondTaskRef.duration;
        
        secondTaskRef.startTime = tempTime;
        secondTaskRef.duration = tempDuration;
        
        // å¤„ç†å¤ä¹ é“¾è¡¨çš„æ—¶é—´ä¼ å¯¼
        if (firstTaskRef.childIds.length > 0) {
            const confirmUpdateA = confirm(
                `ä»»åŠ¡ [${firstTaskRef.title}] æ˜¯å¤ä¹ é“¾è¡¨çˆ¶èŠ‚ç‚¹ï¼Œæ—¶é—´å·²è¢«äº¤æ¢ä¸º ${firstTaskRef.startTime} / ${firstTaskRef.duration}mã€‚\n` +
                `æ˜¯å¦å°†æ–°çš„æ—¶é—´/æ—¶é•¿ä¼ å¯¼ç»™åç»­ ${firstTaskRef.childIds.length} ä¸ªå­ä»»åŠ¡ï¼Ÿ`
            );
            if (confirmUpdateA) {
                updateChildTasks(
                    firstTaskRef.id, 
                    firstTaskRef.plannedDate, 
                    firstTaskRef.startTime, 
                    firstTaskRef.duration
                );
            }
        }
        
        if (secondTaskRef.childIds.length > 0) {
            const confirmUpdateB = confirm(
                `ä»»åŠ¡ [${secondTaskRef.title}] æ˜¯å¤ä¹ é“¾è¡¨çˆ¶èŠ‚ç‚¹ï¼Œæ—¶é—´å·²è¢«äº¤æ¢ä¸º ${secondTaskRef.startTime} / ${secondTaskRef.duration}mã€‚\n` +
                `æ˜¯å¦å°†æ–°çš„æ—¶é—´/æ—¶é•¿ä¼ å¯¼ç»™åç»­ ${secondTaskRef.childIds.length} ä¸ªå­ä»»åŠ¡ï¼Ÿ`
            );
            if (confirmUpdateB) {
                updateChildTasks(
                    secondTaskRef.id, 
                    secondTaskRef.plannedDate, 
                    secondTaskRef.startTime, 
                    secondTaskRef.duration
                );
            }
        }
        
        // æ¸…é™¤é«˜äº®æ ·å¼
        document.querySelectorAll('.task-item').forEach(el => {
            el.classList.remove('bg-yellow-100', 'border-yellow-400', 'ring-2', 'ring-yellow-300');
        });
        
        // é€€å‡ºäº¤æ¢æ¨¡å¼
        exchangeMode.value = false;
        taskToExchange.value = null;
    }
};
            const checkTaskConflict = (task, allTasksInDay) => {
                if (!task.startTime || !task.duration || task.status === 'å·²å®Œæˆ') return false;
                
                const taskStart = dayjs(task.plannedDate + ' ' + task.startTime);
                const taskEnd = getTaskEnd(task);
                
                return allTasksInDay.some(other => {
                    if (other.id === task.id || other.status === 'å·²å®Œæˆ') return false;
                    
                    const otherStart = other.startTime ? dayjs(other.plannedDate + ' ' + other.startTime) : null;
                    const otherEnd = getTaskEnd(other);

                    if (!otherStart || !otherEnd) return false;
                    return taskStart.isBefore(otherEnd) && otherStart.isBefore(taskEnd);
                });
            };

            const dayTasks = computed(() => {
                let list = tasks.value
                    .filter(t => t.plannedDate === selectedDate.value);
                    
                if (selectedPriorityFilter.value !== 'all') {
                    list = list.filter(t => t.priority === selectedPriorityFilter.value);
                }

                list = list.sort((a, b) => {
                    const aHasTime = a.startTime && a.duration > 0;
                    const bHasTime = b.startTime && b.duration > 0;

                    if (aHasTime && !bHasTime) return -1;
                    if (!aHasTime && bHasTime) return 1;
                    
                    if (aHasTime && bHasTime) {
                        const timeA = a.startTime;
                        const timeB = b.startTime;
                        if (timeA < timeB) return -1;
                        if (timeA > timeB) return 1;
                    }
                    const priorityOrder = { 'p1': 1, 'p2': 2, 'p3': 3, 'p4': 4 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });
                list.forEach(task => {
                    task.hasConflict = checkTaskConflict(task, list);
                });

                return list;
            });

            const tasksForWeek = computed(() => {
                const start = dayjs(selectedWeekStart.value);
                const end = start.add(6, 'day').format('YYYY-MM-DD');
                const tasksByDay = {};

                tasks.value.forEach(t => {
                    if (dayjs(t.plannedDate).isBetween(start, dayjs(end), 'day', '[]')) {
                        if (!tasksByDay[t.plannedDate]) {
                            tasksByDay[t.plannedDate] = [];
                        }
                        // ç¡®ä¿åªåŒ…å«æœ‰æ—¶é—´çš„ä»»åŠ¡ (æˆ–åŒ…å«æ‰€æœ‰ä»»åŠ¡ä½†åªæ¸²æŸ“æœ‰æ—¶é—´çš„)
                        tasksByDay[t.plannedDate].push(t);
                    }
                });

                // åœ¨è¿™é‡Œå¯ä»¥è¿›è¡Œæ¯å‘¨çš„ä»»åŠ¡å†²çªæ£€æŸ¥ï¼Œä½†ä¸ºç®€åŒ–ï¼Œæ²¿ç”¨æ—¥è§†å›¾çš„é€»è¾‘ã€‚
                return tasksByDay;
            });
            
            // è®¡ç®—ä»»åŠ¡åœ¨å‘¨/æ—¥è§†å›¾ä¸­çš„ä½ç½®å’Œé«˜åº¦
            const getTaskPosition = (task, isWeekView = false) => {
                if (!task.startTime || !task.duration) return {};
                const [h, m] = task.startTime.split(':').map(Number);
                
                // è½¬æ¢ä¸ºåˆ†é’Ÿæ€»æ•°
                const startMinutes = h * 60 + m;
                const durationMinutes = task.duration;

                // ä¸€å°æ—¶ 60px
                const top = (startMinutes / 60) * 60 + (isWeekView ? 0 : 0); // 1åˆ†é’Ÿ 1px
                
                // é«˜åº¦
                const height = (durationMinutes / 60) * 60;
                
                return {
                    top: `${top}px`,
                    height: `${height}px`,
                    position: 'absolute'
                };
            };

            // --- æœˆè§†å›¾é€»è¾‘ ---
            const changeMonth = (off) => {
                selectedMonthStart.value = dayjs(selectedMonthStart.value).add(off, 'month').startOf('month').format('YYYY-MM-DD');
            };
            const goToTodayMonth = () => {
                selectedMonthStart.value = dayjs().startOf('month').format('YYYY-MM-DD');
            };
            const goToDay = (date) => {
                selectedDate.value = date;
                currentView.value = 'day';
            };
            
            const monthCalendar = computed(() => {
                const startOfMonth = dayjs(selectedMonthStart.value);
                // æ‰¾å‡ºå½“æœˆç¬¬ä¸€å¤©æ‰€åœ¨å‘¨çš„å‘¨ä¸€
                let startDay = startOfMonth.weekday(0);

                const days = [];
                let currentDay = startDay;
                
                // ä»»åŠ¡/ä¹ æƒ¯æ•°æ®å‡†å¤‡
                const tasksByDate = tasks.value.reduce((acc, t) => {
                    acc[t.plannedDate] = acc[t.plannedDate] || [];
                    acc[t.plannedDate].push(t);
                    return acc;
                }, {});

                const habitHistoryByDate = habits.value.flatMap(h => h.stats.history).reduce((acc, h) => {
                    acc[h.date] = acc[h.date] || [];
                    acc[h.date].push(h);
                    return acc;
                }, {});


                // ç”Ÿæˆæ—¥å†
                while (currentDay.isBefore(startOfMonth.add(1, 'month').weekday(7))) {
                    const date = currentDay.format('YYYY-MM-DD');
                    const isCurrentMonth = currentDay.month() === startOfMonth.month();
                    
                    const dayTasks = tasksByDate[date] || [];
                    const habitTasks = dayTasks.filter(t => t.isGeneratedFromHabit);

                    let habitDoneCount = 0;
                    if (habitTasks.length > 0) {
                        habitDoneCount = habitTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
                    } else {
                         // æ£€æŸ¥æˆ’æ–­å‹ä¹ æƒ¯çš„ä¼‘æ¯æ—¥æˆ–å¤±è´¥è®°å½•
                         const applicableHabits = habits.value.filter(h => dayjs(date).isBetween(dayjs(h.dateRange.start), dayjs(h.dateRange.end), 'day', '[]'));
                         // å¯¹äºéä»»åŠ¡ç”Ÿæˆçš„ä¹ æƒ¯ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ä¼‘æ¯æ—¥
                         applicableHabits.forEach(h => {
                             if (isDateARestDay(h, date)) {
                                 habitDoneCount++;
                             } else if (h.type === 'abstinence') {
                                 // æˆ’æ–­å‹ï¼Œå¦‚æœå½“å¤©æ²¡æœ‰å¤±è´¥è®°å½•ï¼Œåˆ™è®¤ä¸ºå®Œæˆ
                                 const isFail = h.stats.history.some(hist => hist.date === date && hist.status === 'fail');
                                 if (!isFail) {
                                     habitDoneCount++;
                                 }
                             }
                         });
                    }
                    
                    days.push({
                        date,
                        isCurrentMonth,
                        count: dayTasks.length,
                        taskCount: dayTasks.filter(t => !t.isGeneratedFromHabit).length,
                        habitCount: habitTasks.length,
                        habitDone: habitDoneCount
                    });
                    
                    currentDay = currentDay.add(1, 'day');
                }

                // ç¡®ä¿è‡³å°‘æœ‰ 6 å‘¨ (42å¤©) ä¿è¯æ’ç‰ˆç¨³å®š
                while (days.length < 42) {
                    const date = currentDay.format('YYYY-MM-DD');
                    days.push({
                        date,
                        isCurrentMonth: false,
                        count: 0,
                        taskCount: 0,
                        habitCount: 0,
                        habitDone: 0
                    });
                    currentDay = currentDay.add(1, 'day');
                }
                
                return days;
            });

            // --- æ‹–æ‹½é€»è¾‘ ---
            const dragStart = (id, index) => {
                draggedTask.value = id;
                dragMode.value = 'move';
            };
            
            // æ‹–æ‹½æ”¾ä¸‹ï¼šæ‰§è¡Œäº¤æ¢å¹¶å¤„ç†æ—¶é—´äº¤æ¢
            const dropTask = (targetId, targetIndex) => {
                event.target.closest('div.task-item').classList.remove('opacity-50');
                if (draggedTask.value === targetId) return; // æ‹–åˆ°è‡ªèº«

                const tasksToReorder = dayTasks.value.slice(); // å¤åˆ¶å½“æ—¥ä»»åŠ¡åˆ—è¡¨ï¼ˆComputedï¼‰
                const taskToMove = tasksToReorder.find(t => t.id === draggedTask.value);
                const targetTask = tasksToReorder[targetIndex];
                
                if (!taskToMove || !targetTask) return;
                const taskToMoveRef = tasks.value.find(t => t.id === taskToMove.id);
                const targetTaskRef = tasks.value.find(t => t.id === targetTask.id);

                if (!taskToMoveRef || !targetTaskRef) return;

                const tempTime = taskToMoveRef.startTime;
                const tempDuration = taskToMoveRef.duration;

                taskToMoveRef.startTime = targetTaskRef.startTime;
                taskToMoveRef.duration = targetTaskRef.duration;

                targetTaskRef.startTime = tempTime;
                targetTaskRef.duration = tempDuration;
                
                if (taskToMoveRef.childIds.length > 0) {
                    const confirmUpdateA = confirm(
                        `ä»»åŠ¡ [${taskToMoveRef.title}] æ˜¯å¤ä¹ é“¾è¡¨çˆ¶èŠ‚ç‚¹ï¼Œæ—¶é—´å·²è¢«äº¤æ¢ä¸º ${taskToMoveRef.startTime} / ${taskToMoveRef.duration}mã€‚\n` +
                        `æ˜¯å¦å°†æ–°çš„æ—¶é—´/æ—¶é•¿ä¼ å¯¼ç»™åç»­ ${taskToMoveRef.childIds.length} ä¸ªå­ä»»åŠ¡ï¼Ÿ`
                    );
                    if (confirmUpdateA) {
                         updateChildTasks(
                            taskToMoveRef.id, 
                            taskToMoveRef.plannedDate, 
                            taskToMoveRef.startTime, 
                            taskToMoveRef.duration
                         );
                    }
                }

                if (targetTaskRef.childIds.length > 0) {
                    const confirmUpdateB = confirm(
                        `ä»»åŠ¡ [${targetTaskRef.title}] æ˜¯å¤ä¹ é“¾è¡¨çˆ¶èŠ‚ç‚¹ï¼Œæ—¶é—´å·²è¢«äº¤æ¢ä¸º ${targetTaskRef.startTime} / ${targetTaskRef.duration}mã€‚\n` +
                        `æ˜¯å¦å°†æ–°çš„æ—¶é—´/æ—¶é•¿ä¼ å¯¼ç»™åç»­ ${targetTaskRef.childIds.length} ä¸ªå­ä»»åŠ¡ï¼Ÿ`
                    );
                    if (confirmUpdateB) {
                         updateChildTasks(
                            targetTaskRef.id, 
                            targetTaskRef.plannedDate, 
                            targetTaskRef.startTime, 
                            targetTaskRef.duration
                         );
                    }
                }
            };

            // --- ä»»åŠ¡ CRUD ---
            const openTaskModal = (mode, task, plannedDate = null) => {
                modalMode.value = mode;
                if(mode==='create') {
                    editingTask.value = { 
                        id: generateUniqueId('t_'), 
                        title: '', 
                        type: 'å·¥ä½œ', 
                        priority: 'p3', 
                        plannedDate: plannedDate || todayDate, 
                        startTime: '', 
                        duration: 60, 
                        status: 'æœªå¼€å§‹',
                        isReviewTask: false,
                        customIntervals: '',
                        preId: null,
                        childIds: [],
                        hasConflict: false,
                        habitId: null, 
                        isGeneratedFromHabit: false 
                    };
                } else {
                    editingTask.value = JSON.parse(JSON.stringify(task)); // è®°å½•åŸå§‹å€¼ç”¨äºä¿å­˜æ—¶çš„å˜åŒ–æ£€æŸ¥
                    originalEditingTask.value = JSON.parse(JSON.stringify(task));
                    editingTask.value.isReviewTask = editingTask.value.childIds.length > 0;
                    editingTask.value.customIntervals = ''; // ç¼–è¾‘æ—¶ä¸æ˜¾ç¤ºå¤ä¹ é—´éš”
                }
                showTaskModal.value = true;
            };
            
            /**
             * é€’å½’æ›´æ–°å­ä»»åŠ¡çš„æ—¶é—´/æ—¶é•¿
             * @param {string} parentId å½“å‰æ›´æ–°çš„çˆ¶èŠ‚ç‚¹ID
             * @param {string} basePlannedDate å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æ–°è®¡åˆ’æ—¥æœŸ
             * @param {string} baseStartTime å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æ–°å¼€å§‹æ—¶é—´
             * @param {number} baseDuration å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æ–°æŒç»­æ—¶é•¿
             */
            const updateChildTasks = (parentId, basePlannedDate, baseStartTime, baseDuration) => {
                const parentTask = tasks.value.find(t => t.id === parentId);
                if (!parentTask || parentTask.childIds.length === 0) return;

                // å¦‚æœ `parentId` æ˜¯é“¾è¡¨çš„**å¤´èŠ‚ç‚¹** (å³ `parentTask.preId === null`)
                if (parentTask.preId === null) {
                    const chainHeadTask = parentTask;
                    let nextId = chainHeadTask.childIds[0];
                    let currentTask = chainHeadTask;

                    let currentRef = currentTask;
                    while(nextId) {
                        const nextTask = tasks.value.find(t => t.id === nextId);
                        if (nextTask) {
                            nextTask.startTime = baseStartTime;
                            nextTask.duration = baseDuration;
                            currentRef = nextTask;
                            nextId = nextTask.childIds[0];
                        } else {
                            nextId = null; 
                        }
                    }
                } else {
                    // å¦‚æœä¼ å…¥çš„ `parentId` æ˜¯é“¾è¡¨çš„ä¸­é—´èŠ‚ç‚¹ï¼Œåˆ™åªæ›´æ–°å…¶åçš„ä»»åŠ¡
                    let nextId = parentTask.childIds[0];
                    while(nextId) {
                        const nextTask = tasks.value.find(t => t.id === nextId);
                        if (nextTask) {
                            nextTask.startTime = baseStartTime;
                            nextTask.duration = baseDuration;
                            nextId = nextTask.childIds[0];
                        } else {
                            nextId = null;
                        }
                    }
                }
            };
            
            const saveTask = () => {
                if (!editingTask.value.title) {
                    alert('ä»»åŠ¡æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                const isNew = modalMode.value === 'create';
                const taskData = editingTask.value;

                if(isNew) {
                    tasks.value.push(taskData);
                    
                    // å¤„ç†å¤ä¹ é“¾è¡¨ç”Ÿæˆ
                    if (taskData.isReviewTask && taskData.type === 'å­¦ä¹ ') {
                        let intervals = appSettings.defaultReviewIntervals;
                        if (taskData.customIntervals) {
                            intervals = taskData.customIntervals.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n > 0);
                        }
                        
                        let prevId = taskData.id;
                        let currentTask = taskData;
                        
                        intervals.forEach(dayOff => {
                            const nextDate = dayjs(currentTask.plannedDate).add(dayOff, 'day').format('YYYY-MM-DD');
                            const subId = generateUniqueId('t_');
                            
                            const subTask = {
                                ...currentTask,
                                id: subId,
                                title: `(å¤ä¹ +${dayOff}d) ${currentTask.title}`,
                                plannedDate: nextDate, // æ—¥æœŸåç§»
                                status: 'æœªå¼€å§‹',
                                isReviewTask: false,
                                preId: prevId, // æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹
                                childIds: []
                            };
                            tasks.value.push(subTask);

                            // æ›´æ–°ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„ childIds
                            const prevTask = tasks.value.find(t => t.id === prevId);
                            if (prevTask) {
                                prevTask.childIds.push(subId);
                            }
                            prevId = subId;
                        });
                    }
                } else {
                    // ç¼–è¾‘ä»»åŠ¡
                    const index = tasks.value.findIndex(t => t.id === taskData.id);
                    if (index !== -1) {
                        // å¦‚æœä¿®æ”¹äº†æœ‰å¤ä¹ é“¾è¡¨çš„ä»»åŠ¡çš„æ—¶é—´/æ—¶é•¿ï¼Œæç¤ºæ›´æ–°å­ä»»åŠ¡
                        const originalTask = originalEditingTask.value;
                        const timeChanged = originalTask.startTime !== taskData.startTime || originalTask.duration !== taskData.duration;
                        
                        // å¦‚æœæ˜¯çˆ¶èŠ‚ç‚¹ä¸”æ—¶é—´å‘ç”Ÿå˜åŒ–ï¼Œè¿›è¡Œæç¤º
                        if (timeChanged && taskData.childIds && taskData.childIds.length > 0) {
                            const confirmUpdate = confirm(
                                `ä»»åŠ¡ [${taskData.title}] æ˜¯å¤ä¹ é“¾è¡¨çˆ¶èŠ‚ç‚¹ã€‚\n` +
                                `æ—¶é—´æˆ–æ—¶é•¿å·²è¢«ä¿®æ”¹ä¸º ${taskData.startTime || 'æ— æ—¶é—´'} / ${taskData.duration || 0}mã€‚\n` +
                                `æ˜¯å¦å°†æ–°çš„æ—¶é—´/æ—¶é•¿ä¼ å¯¼ç»™åç»­ ${taskData.childIds.length} ä¸ªå­ä»»åŠ¡ï¼Ÿ`
                            );
                            if (confirmUpdate) {
                                 updateChildTasks(
                                    taskData.id, 
                                    taskData.plannedDate, 
                                    taskData.startTime, 
                                    taskData.duration
                                 );
                            }
                        }
                        
                        tasks.value[index] = taskData;
                    }
                }
                
                showTaskModal.value = false;
            };

            const allTasks = computed(() => tasks.value);

            const deleteTask = (id) => {
    const taskIndex = tasks.value.findIndex(t => t.id === id);
    if (taskIndex === -1) return;

    const taskToDelete = tasks.value[taskIndex];

    if (taskToDelete.childIds.length > 0) {
        if (!confirm(`ä»»åŠ¡ [${taskToDelete.title}] æ˜¯å¤ä¹ çˆ¶èŠ‚ç‚¹ï¼Œç¡®è®¤åˆ é™¤å®ƒå—ï¼Ÿ`)) {
            return; 
        }
        tasks.value.splice(taskIndex, 1);
        
        if (taskToDelete.childIds.length > 0) {
            if (confirm(`ä»»åŠ¡ [${taskToDelete.title}] å·²è¢«åˆ é™¤ã€‚\n` + 
                        `æ˜¯å¦åŒæ—¶åˆ é™¤å…¶åç»­ ${taskToDelete.childIds.length} ä¸ªå­ä»»åŠ¡é“¾è¡¨ï¼Ÿ`)) {
                // YES: åˆ é™¤æ‰€æœ‰å­ä»»åŠ¡
                let currentId = taskToDelete.childIds[0];
                // ä½¿ç”¨ while å¾ªç¯åˆ é™¤æ‰€æœ‰å­èŠ‚ç‚¹
                while(currentId) {
                    const currentIndex = tasks.value.findIndex(t => t.id === currentId); 
                    if (currentIndex !== -1) {
                        const currentTask = tasks.value[currentIndex];
                        tasks.value.splice(currentIndex, 1); // åˆ é™¤å½“å‰å­ä»»åŠ¡
                        currentId = currentTask.childIds.length > 0 ? currentTask.childIds[0] : null; // è·å–ä¸‹ä¸€ä¸ª ID
                    } else {
                        currentId = null;
                    }
                }
            } else {
                // NO: ä¿ç•™å­ä»»åŠ¡ï¼Œæ–­å¼€é“¾æ¡ (ç¬¬ä¸€ä¸ªå­ä»»åŠ¡çš„ preId ç½®ç©º)
                const firstChildId = taskToDelete.childIds[0];
                const firstChild = tasks.value.find(t => t.id === firstChildId);
                if (firstChild) {
                    firstChild.preId = null; // å°†ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹çš„ preId ç½®ç©ºï¼Œä½¿å…¶æˆä¸ºæ–°çš„ç‹¬ç«‹ä»»åŠ¡
                }
            }
        }
        return; 
    } 
    else {
        if (!confirm(`ç¡®è®¤åˆ é™¤ä»»åŠ¡ [${taskToDelete.title}] å—ï¼Ÿ`)) {
            return; 
        }
        
        if (taskToDelete.preId) {
            // å­èŠ‚ç‚¹ï¼šç»´æŠ¤é“¾æ¡
            const prevTask = tasks.value.find(t => t.id === taskToDelete.preId);
            const nextTask = taskToDelete.childIds.length > 0 ? tasks.value.find(t => t.id === taskToDelete.childIds[0]) : null;
            
            if (prevTask) {
                prevTask.childIds = taskToDelete.childIds; 
            }
            if (nextTask) {
                nextTask.preId = taskToDelete.preId; 
            }
        } 
        
        // ç§»é™¤å½“å‰ä»»åŠ¡ï¼ˆå­èŠ‚ç‚¹æˆ–æ™®é€šä»»åŠ¡ï¼‰
        tasks.value.splice(taskIndex, 1);
    }
};
            
            const toggleTaskStatus = (task) => {
                // å¦‚æœæ˜¯ä¹ æƒ¯ç”Ÿæˆçš„ä»»åŠ¡ï¼Œå®Œæˆä»»åŠ¡çš„åŒæ—¶æ›´æ–°ä¹ æƒ¯è¿å‡»
                if (task.isGeneratedFromHabit) {
                    const habit = habits.value.find(h => h.id === task.habitId);
                    if (habit) {
                         // åªæœ‰å½“çŠ¶æ€ä» 'æœªå®Œæˆ' -> 'å·²å®Œæˆ' æ—¶æ‰è§¦å‘æˆåŠŸæ‰“å¡é€»è¾‘
                        if (task.status !== 'å·²å®Œæˆ') {
                            task.status = 'å·²å®Œæˆ';
                            updateHabitStreak(habit, 'success');
                        } else {
                            // ä» 'å·²å®Œæˆ' -> 'æœªå®Œæˆ'
                            task.status = 'æœªå¼€å§‹';
                            // ç†è®ºä¸Šåº”è¯¥å›æ»šè¿å‡»ï¼Œä½†é€»è¾‘å¤æ‚ï¼Œè¿™é‡Œç®€åŒ–ä¸å›æ»šï¼Œåªæ›´æ–°çŠ¶æ€
                        }
                        return;
                    }
                }
                
                // æ™®é€šä»»åŠ¡
                task.status = task.status === 'å·²å®Œæˆ' ? 'æœªå¼€å§‹' : 'å·²å®Œæˆ';

                // å¦‚æœæ˜¯å¤ä¹ é“¾è¡¨çš„çˆ¶èŠ‚ç‚¹ï¼Œä¸”å®Œæˆäº†ï¼Œæç¤ºå®Œæˆå­èŠ‚ç‚¹ (å¯é€‰)
                if (task.status === 'å·²å®Œæˆ' &&task.childIds.length > 0) {
                    if (confirm(`ä»»åŠ¡ [${task.title}] æ˜¯å¤ä¹ çˆ¶èŠ‚ç‚¹ï¼Œæ˜¯å¦ä¸€å¹¶å®Œæˆæ‰€æœ‰ ${task.childIds.length} ä¸ªå­ä»»åŠ¡ï¼Ÿ`)) {
                        let nextId = task.childIds[0];
                        while(nextId) {
                            const nextTask = tasks.value.find(t => t.id === nextId);
                            if(nextTask) {
                                nextTask.status = 'å·²å®Œæˆ';
                                nextId = nextTask.childIds[0];
                            } else {
                                nextId = null;
                            }
                        }
                    }
                }
            };

            // è¿‡æ»¤çŸ­æœŸä»»åŠ¡ (short_term)
            const filteredShortTasks = computed(() => {
                // æ’é™¤ä¹ æƒ¯ç”Ÿæˆçš„ä»»åŠ¡
                let list = tasks.value.filter(t => t.isGeneratedFromHabit !== true); 
                
                if (shortTermFilterStatus.value === 'completed') {
                    list = list.filter(t => t.status === 'å·²å®Œæˆ');
                } else if (shortTermFilterStatus.value === 'uncompleted') {
                    list = list.filter(t => t.status !== 'å·²å®Œæˆ');
                }
                
                if (shortTermFilterPriority.value !== 'all') {
                    list = list.filter(t => t.priority === shortTermFilterPriority.value);
                }
                const startDate = shortTermFilterStartDate.value;
                const endDate = shortTermFilterEndDate.value;

                if (startDate) {
                    list = list.filter(t => dayjs(t.plannedDate).isSameOrAfter(dayjs(startDate)));
                }
                if (endDate) {
                    list = list.filter(t => dayjs(t.plannedDate).isSameOrBefore(dayjs(endDate)));
                }
                return list.sort((a, b) => {
                    // æœªå®Œæˆä¼˜å…ˆ
                    if (a.status !== 'å·²å®Œæˆ' && b.status === 'å·²å®Œæˆ') return -1;
                    if (a.status === 'å·²å®Œæˆ' && b.status !== 'å·²å®Œæˆ') return 1;

                    // è®¡åˆ’æ—¥æœŸæ—©çš„ä¼˜å…ˆ
                    if (dayjs(a.plannedDate).isBefore(dayjs(b.plannedDate))) return -1;
                    if (dayjs(a.plannedDate).isAfter(dayjs(b.plannedDate))) return 1;

                    // ä¼˜å…ˆçº§é«˜çš„ä¼˜å…ˆ
                    const priorityOrder = { 'p1': 1, 'p2': 2, 'p3': 3, 'p4': 4 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });
            });

            // --- ä¹ æƒ¯é€»è¾‘ ---
            const toggleBreakDay = (day) => {
    const index = editingHabit.value.breakDays.indexOf(day);
    if (index === -1) {
        editingHabit.value.breakDays.push(day);
    } else {
        editingHabit.value.breakDays.splice(index, 1);
    }
};

const isDateARestDay = (habit, dateString) => {
    const { breakCycleN, breakDays } = habit;
    if (!breakCycleN || breakDays.length === 0) return false;

    const startDate = dayjs(habit.dateRange.start);
    const targetDate = dayjs(dateString);
    
    if (targetDate.isBefore(startDate)) return false; 

    // å¦‚æœå‘¨æœŸæ˜¯7å¤©ï¼ˆä¸€å‘¨ï¼‰ï¼Œä½¿ç”¨æ˜ŸæœŸå‡ åˆ¤æ–­
    if (breakCycleN === 7) {
        // dayjsçš„day()æ–¹æ³•ï¼š0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
        const weekday = targetDate.day();
        return breakDays.includes(weekday);
    } else {
        // å…¶ä»–å‘¨æœŸï¼Œè®¡ç®—æ˜¯ç¬¬å‡ å¤©
        const diffInDays = targetDate.diff(startDate, 'day');
        const cycleN = parseInt(breakCycleN);
        const dayInCycle = (diffInDays % cycleN) + 1; 
        return breakDays.includes(dayInCycle);
    }
}

            
            const isTodayARestDay = (habit) => {
                const today = dayjs().format('YYYY-MM-DD');
                return isDateARestDay(habit, today);
            };

            const isHabitDoneToday = (habit) => {
    const today = dayjs().format('YYYY-MM-DD');
    
    if (isTodayARestDay(habit)) {
        return true;
    }

    if (habit.type === 'action') {
        const dailyTask = tasks.value.find(t => t.plannedDate === today && t.habitId === habit.id && t.isGeneratedFromHabit);
        return dailyTask && dailyTask.status === 'å·²å®Œæˆ';
    } else if (habit.type === 'abstinence') {
        return habit.stats.history.some(h => h.date === today && h.status === 'success');
    }
    return false;
};

            const checkInHabit = (habit) => {
    const today = dayjs().format('YYYY-MM-DD');
    
    if (isTodayARestDay(habit)) {
        alert('ä»Šå¤©æ˜¯ä¼‘æ¯æ—¥ï¼Œæ— éœ€æ‰“å¡ï¼');
        return;
    }
    
    if (isHabitDoneToday(habit)) {
        alert('ä»Šæ—¥å·²æ‰“å¡ï¼');
        return;
    }
    
    if (habit.type === 'action') {
        const dailyTask = tasks.value.find(t => t.plannedDate === today && t.habitId === habit.id && t.isGeneratedFromHabit);
        if (dailyTask) {
            dailyTask.status = 'å·²å®Œæˆ';
            updateHabitStreak(habit, 'success');
        } else {
            checkDailyHabitGeneration(true);
            const newTask = tasks.value.find(t => t.plannedDate === today && t.habitId === habit.id && t.isGeneratedFromHabit);
            if (newTask) {
                newTask.status = 'å·²å®Œæˆ';
                updateHabitStreak(habit, 'success');
            }
        }
    } else if (habit.type === 'abstinence') {
        habit.stats.history.push({ date: today, status: 'success' });
        updateHabitStreak(habit, 'success');
        alert(`âœ… æˆ’æ–­å‹ä¹ æƒ¯ã€${habit.name}ã€‘æ‰“å¡æˆåŠŸï¼`);
    }
};

// æ›´æ–°ä¹ æƒ¯è¿å‡»
const updateHabitStreak = (habit, status) => {
    const today = dayjs().format('YYYY-MM-DD');
    
    if (status === 'success') {
        let streakCount = 1;
        let currentDate = dayjs(today).subtract(1, 'day');
        
        while(currentDate.isSameOrAfter(dayjs(habit.dateRange.start))) {
            const dateStr = currentDate.format('YYYY-MM-DD');
            
            if (isDateARestDay(habit, dateStr)) {
                streakCount++;
                currentDate = currentDate.subtract(1, 'day');
                continue;
            }
            
            let isDone = false;
            if (habit.type === 'action') {
                const task = tasks.value.find(t => t.plannedDate === dateStr && t.habitId === habit.id && t.isGeneratedFromHabit);
                isDone = task && task.status === 'å·²å®Œæˆ';
            } else if (habit.type === 'abstinence') {
                isDone = habit.stats.history.some(h => h.date === dateStr && h.status === 'success');
            }
            
            if (isDone) {
                streakCount++;
                currentDate = currentDate.subtract(1, 'day');
            } else {
                break;
            }
        }
        
        habit.stats.currentStreak = streakCount;
    } else if (status === 'fail') {
        habit.stats.currentStreak = 0;
    }

    if (habit.stats.maxStreak < habit.stats.currentStreak) {
        habit.stats.maxStreak = habit.stats.currentStreak;
    }
};

// è®¡ç®—ä¹ æƒ¯å®Œæˆç‡
const calculateRate = (habit) => {
    if (!habit.stats.history || habit.stats.history.length === 0) return 0;

    const startDate = dayjs(habit.dateRange.start);
    const today = dayjs();
    
    let totalActionableDays = 0;
    let currentDate = startDate;
    while (currentDate.isSameOrBefore(today)) {
        if (!isDateARestDay(habit, currentDate.format('YYYY-MM-DD'))) {
            totalActionableDays++;
        }
        currentDate = currentDate.add(1, 'day');
    }
    
    if (totalActionableDays <= 0) return 0;
    
    let successCount = 0;
    if (habit.type === 'action') {
        successCount = tasks.value.filter(t => t.habitId === habit.id && t.isGeneratedFromHabit && t.status === 'å·²å®Œæˆ').length;
    } else if (habit.type === 'abstinence') {
        successCount = habit.stats.history.filter(h => h.status === 'success').length;
    }

    return Math.round((successCount / totalActionableDays) * 100);
};

// è·å–æŸä¸€å¤©çš„æ‰“å¡çŠ¶æ€æ ·å¼
const getDayStatusClass = (habit, dateString) => {
    const today = dayjs().format('YYYY-MM-DD');
    
    if (isDateARestDay(habit, dateString)) {
        return 'bg-gray-100 text-gray-400';
    }
    
    let isDone = false;
    if (habit.type === 'action') {
        const task = tasks.value.find(t => t.plannedDate === dateString && t.habitId === habit.id && t.isGeneratedFromHabit);
        isDone = task && task.status === 'å·²å®Œæˆ';
    } else if (habit.type === 'abstinence') {
        isDone = habit.stats.history.some(h => h.date === dateString && h.status === 'success');
    }
    
    if (isDone) {
        return dateString === today ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700';
    } else {
        return dateString === today ? 'bg-red-100 text-red-700' : 'bg-gray-50 text-gray-400';
    }
};
            // --- ä¹ æƒ¯ CRUD ---
            const openHabitModal = (mode, habit) => {
    modalMode.value = mode;
    if(mode==='create') {
        editingHabit.value = {
            id: generateUniqueId('h_'),
            name: '',
            type: 'action',
            active: true,
            desc: '',
            dateRange: { start: todayDate, end: dayjs().add(1,'year').format('YYYY-MM-DD') },
            stats: { currentStreak: 0, maxStreak: 0, history: [] },
            defaultTime: '09:00',
            duration: 30,
            breakCycleN: 7,
            breakDays: []
        };
    } else {
        const tempHabit = JSON.parse(JSON.stringify(habit));
        if (tempHabit.breakCycleN === undefined) tempHabit.breakCycleN = 7;
        if (tempHabit.breakDays === undefined) tempHabit.breakDays = [];
        editingHabit.value = tempHabit;
    }
    showHabitModal.value = true;
};

// ä¿å­˜ä¹ æƒ¯
const saveHabit = () => {
    if (editingHabit.value.type === 'abstinence') {
        editingHabit.value.defaultTime = '';
        editingHabit.value.duration = 0;
    }

    if (!editingHabit.value.name) {
        alert('ä¹ æƒ¯åç§°ä¸èƒ½ä¸ºç©º');
        return;
    }

    if (modalMode.value === 'create') {
        habits.value.push(editingHabit.value);
    } else {
        const index = habits.value.findIndex(h => h.id === editingHabit.value.id);
        if (index !== -1) {
            habits.value[index] = editingHabit.value;
        }
    }
    
    updateHabitStreak(editingHabit.value, 'none');
    showHabitModal.value = false;
};

// åˆ é™¤ä¹ æƒ¯
const deleteHabit = (id) => {
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä¹ æƒ¯æ¨¡æ¿å—? å…³è”çš„ä»»åŠ¡å°†ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚')) return;
    habits.value = habits.value.filter(h => h.id !== id);
    tasks.value = tasks.value.filter(t => t.habitId !== id);
    projects.value.forEach(p => {
        p.milestones.forEach(ms => {
            ms.contents = ms.contents.filter(item => !(item.type === 'habit' && item.refId === id));
        });
    });
};
            // --- é¡¹ç›®/é‡Œç¨‹ç¢‘ ---
            const calculateProjectProgress = (project) => {
                if (project.milestones.length === 0) return 0;
                let totalItems = 0;
                let completedItems = 0;
                
                project.milestones.forEach(ms => {
                    ms.contents.forEach(item => {
                        totalItems++;
                        if (isItemDone(item)) {
                            completedItems++;
                        }
                    });
                });

                if (totalItems === 0) return 0;
                return Math.round((completedItems / totalItems) * 100);
            };

            const getItemTitle = (item) => {
                if(item.type==='task') return tasks.value.find(t=>t.id===item.refId)?.title || 'æœªçŸ¥ä»»åŠ¡';
                if(item.type==='habit') return habits.value.find(h=>h.id===item.refId)?.name || 'æœªçŸ¥ä¹ æƒ¯';
                return 'æœªçŸ¥é¡¹ç›®';
            };
            
            const isItemDone = (item) => {
                if(item.type==='task') return tasks.value.find(t=>t.id===item.refId)?.status==='å·²å®Œæˆ';
                if(item.type==='habit') {
                    // ä¹ æƒ¯å…³è”é¡¹æ£€æŸ¥ï¼šå¦‚æœæ˜¯ä¼‘æ¯æ—¥ï¼Œä¹Ÿç®—å®Œæˆï¼›å¦åˆ™æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰“å¡/å¤±è´¥
                    const h = habits.value.find(h=>h.id===item.refId);
                    if (!h) return false;
                    
                    const today = dayjs().format('YYYY-MM-DD');
                    // å¦‚æœé¡¹ç›®å…³è”çš„ä¹ æƒ¯ä»Šå¤©æ˜¯ä¼‘æ¯æ—¥
                    if (isDateARestDay(h, today)) {
                        return true;
                    }
                    
                    // å¦åˆ™ï¼Œä½¿ç”¨ isHabitDoneToday çš„é€»è¾‘
                    return isHabitDoneToday(h);
                }
                return false;
            };

            const openProjectModal = (mode, project) => {
                modalMode.value = mode;
                if(mode==='create') {
                    editingProject.value = { id: generateUniqueId('p_'), name: '', milestones: [] };
                } else {
                    editingProject.value = JSON.parse(JSON.stringify(project));
                }
                showProjectModal.value = true;
            };
            const saveProject = () => {
                if(!editingProject.value.name) {
                    alert('é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©º');
                    return;
                }
                if (modalMode.value === 'create') {
                    projects.value.push(editingProject.value);
                } else {
                    const index = projects.value.findIndex(p => p.id === editingProject.value.id);
                    if (index !== -1) {
                        projects.value[index] = editingProject.value;
                    }
                }
                showProjectModal.value = false;
            };
            const deleteProject = (id) => {
                if(!confirm('ç¡®å®šåˆ é™¤æ­¤é¡¹ç›®å—? (ä¸ä¼šåˆ é™¤å…³è”çš„ä»»åŠ¡/ä¹ æƒ¯)')) return;
                projects.value = projects.value.filter(p=>p.id!==id);
            };
            
            const openMilestoneModal = (p) => {
                currentProject.value = p;
                editingMilestone.value = { id: generateUniqueId('m_'), name: '', contents: [] };
                showMilestoneModal.value = true;
            };
            const saveMilestone = () => {
                if(!editingMilestone.value.name) {
                    alert('é‡Œç¨‹ç¢‘åç§°ä¸èƒ½ä¸ºç©º');
                    return;
                }
                // æ‰¾åˆ°å½“å‰é¡¹ç›®å¹¶æ·»åŠ é‡Œç¨‹ç¢‘
                const projectRef = projects.value.find(p => p.id === currentProject.value.id);
                if (projectRef) {
                    projectRef.milestones.push(editingMilestone.value);
                }
                showMilestoneModal.value = false;
            };
            const deleteMilestone = (project, msId) => {
                if(!confirm('ç¡®å®šåˆ é™¤æ­¤é‡Œç¨‹ç¢‘å—? (ä¸ä¼šåˆ é™¤å…³è”çš„ä»»åŠ¡/ä¹ æƒ¯)')) return;
                const projectRef = projects.value.find(p => p.id === project.id);
                if (projectRef) {
                    projectRef.milestones = projectRef.milestones.filter(ms => ms.id !== msId);
                }
            };

            const isItemInMilestone = (milestone, refId) => {
                return milestone.contents.some(item => item.refId === refId);
            };

            const openMilestoneContentModal = (p, ms) => {
                currentProject.value = p;
                currentMilestone.value = ms;
                milestoneTab.value = 'task'; // é»˜è®¤æ‰“å¼€ä»»åŠ¡æ ‡ç­¾
                showMilestoneContentModal.value = true;
            };

            const addToMilestone = (type, refId) => {
                if(!currentMilestone.value || isItemInMilestone(currentMilestone.value, refId)) return;

                // å¦‚æœæ˜¯ä»»åŠ¡ï¼Œä¸”æ˜¯å¤ä¹ é“¾è¡¨çˆ¶èŠ‚ç‚¹ï¼Œåˆ™å…³è”æ•´ä¸ªé“¾è¡¨
                if (type === 'task') {
                    const targetTask = tasks.value.find(t => t.id === refId);
                    if (targetTask && targetTask.childIds.length > 0) {
                        // å…³è”çˆ¶èŠ‚ç‚¹
                        currentMilestone.value.contents.push({ type, refId }); 
                        
                        // å…³è”æ‰€æœ‰å­èŠ‚ç‚¹
                        let currentId = targetTask.childIds[0];
                        let current = targetTask;
                        while(currentId) {
                            current = tasks.value.find(t => t.id === currentId);
                            if (current && !isItemInMilestone(currentMilestone.value, currentId)) {
                                currentMilestone.value.contents.push({ type, refId: currentId });
                            }
                            currentId = current?.childIds[0];
                        }
                        alert(`å…³è”æˆåŠŸï¼å·²å…³è”å¤ä¹ é“¾è¡¨å…± ${targetTask.childIds.length + 1} ä¸ªèŠ‚ç‚¹ã€‚`);
                        return;
                    }
                }
                
                currentMilestone.value.contents.push({ type, refId });
            };

            const removeItemFromMilestone = (milestone, refId) => {
                milestone.contents = milestone.contents.filter(item => item.refId !== refId);
            };

            // --- ç»Ÿè®¡è§†å›¾é€»è¾‘ (æ–°å¢) ---
            const changeStatsWeek = (off) => {
                statsWeekStart.value = dayjs(statsWeekStart.value).add(off, 'week').weekday(0).format('YYYY-MM-DD');
            };
            
            const changeStatsMonth = (off) => {
                statsMonthStart.value = dayjs(statsMonthStart.value).add(off, 'month').startOf('month').format('YYYY-MM-DD');
            };

            const getHeatmapColor = (count) => {
                if (count === 0) return 'bg-gray-100';
                if (count <= 2) return 'bg-green-200';
                if (count <= 5) return 'bg-green-400';
                return 'bg-green-600';
            };

            // å…¨å±€ç»Ÿè®¡æ•°æ®
            const overallStats = computed(() => {
                const totalTasks = tasks.value.length;
                const totalDone = tasks.value.filter(t => t.status === 'å·²å®Œæˆ').length;
                const completionRate = totalTasks > 0 ? Math.round((totalDone / totalTasks) * 100) : 0;
                
                const activeHabits = habits.value.filter(h => h.active).length;
                const maxStreak = habits.value.reduce((max, h) => Math.max(max, h.stats.currentStreak), 0);

                return { totalDone, completionRate, activeHabits, maxStreak };
            });

            // å‘¨ç»Ÿè®¡æ•°æ®
            const weeklyStatsData = computed(() => {
                const start = dayjs(statsWeekStart.value);
                const data = [];
                for (let i = 0; i < 7; i++) {
                    const d = start.add(i, 'day');
                    const dateStr = d.format('YYYY-MM-DD');
                    const dayTasks = tasks.value.filter(t => t.plannedDate === dateStr);
                    data.push({
                        date: dateStr,
                        dayName: getWeekDay(dateStr),
                        total: dayTasks.length,
                        done: dayTasks.filter(t => t.status === 'å·²å®Œæˆ').length
                    });
                }
                return data;
            });
            
            // è®¡ç®—å‘¨è§†å›¾çš„æœ€å¤§å€¼ï¼Œç”¨äºæŸ±çŠ¶å›¾ç¼©æ”¾
            const weeklyStatsMax = computed(() => {
                return Math.max(...weeklyStatsData.value.map(d => d.total), 1); // è‡³å°‘ä¸º1é˜²æ­¢é™¤é›¶
            });

            // æœˆåº¦çƒ­åŠ›å›¾æ•°æ®
            const monthlyHeatmapData = computed(() => {
                const start = dayjs(statsMonthStart.value);
                const daysInMonth = start.daysInMonth();
                const startDayOfWeek = start.weekday(); // 0(Mon) - 6(Sun) based on locale setting
                
                const data = [];
                
                // å¡«å……å‰é¢çš„ç©ºç™½
                for(let i=0; i<startDayOfWeek; i++) {
                    data.push({ isEmpty: true });
                }
                
                // å¡«å……å®é™…æ—¥æœŸ
                for(let i=1; i<=daysInMonth; i++) {
                    const dateStr = start.date(i).format('YYYY-MM-DD');
                    // æ´»è·ƒåº¦ = å®Œæˆçš„ä»»åŠ¡æ•° + ä¹ æƒ¯æ‰“å¡(ç²—ç•¥è®¡ç®—)
                    // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œåªè®¡ç®—å½“å¤©å®Œæˆçš„ä»»åŠ¡æ•°é‡ä½œä¸ºçƒ­åŠ›å€¼
                    const count = tasks.value.filter(t => t.plannedDate === dateStr && t.status === 'å·²å®Œæˆ').length;
                    
                    data.push({
                        date: dateStr,
                        count: count,
                        isEmpty: false
                    });
                }
                return data;
            });
            // --- æš´éœ²ç»™æ¨¡æ¿ ---
            return {
                currentView, compactNavs, tasks, habits, projects, allTasks, // ä½¿ç”¨ compactNavs
                selectedDate, dayTasks, draggedTask, dragStart, dropTask,exchangeMode,
                toggleExchangeMode,
                clickExchangeTask,// æ—¥è§†å›¾æ‹–æ‹½ç›¸å…³
                selectedWeekStart, tasksForWeek, weekDays, // å‘¨è§†å›¾
                selectedMonthStart, monthCalendar, goToDay, changeMonth, goToTodayMonth, // æœˆè§†å›¾
                filteredShortTasks, todayDate, selectedPriorityFilter, // ä¼˜å…ˆçº§ç­›é€‰
                showCloudSyncModal,
                cloudPassword,
                cloudMessage,
                cloudMessageType,
                lastSyncTime,
                isSyncing,
                openCloudSyncModal,
                uploadToCloud,
                downloadFromCloud,
                checkCloudStatus,
                shortTermFilterStatus, 
                shortTermFilterPriority, 
                shortTermFilterStartDate, 
                shortTermFilterEndDate,toggleBreakDay,
                overallStats, weeklyStatsData, weeklyStatsMax, monthlyHeatmapData,
                statsWeekStart, statsMonthStart, changeStatsWeek, changeStatsMonth, getHeatmapColor,
                showHabitModal, showTaskModal, showProjectModal, showMilestoneContentModal, modalMode, showMilestoneModal,
                editingHabit, editingTask, editingProject, currentMilestone, milestoneTab, fileInput, editingMilestone, currentProject,
                checkInHabit, isHabitDoneToday, saveHabit, deleteHabit, calculateRate,
                openHabitModal, openTaskModal, saveTask, deleteTask, toggleTaskStatus,
                openProjectModal, saveProject, deleteProject, calculateProjectProgress, removeItemFromMilestone,
                openMilestoneModal, openMilestoneContentModal, addToMilestone, getItemTitle, isItemDone, isItemInMilestone, deleteMilestone, saveMilestone, 
                changeDate, changeWeek, goToTodayWeek, getWeekDay, getTaskPosition,
                getPriorityColor, getPriorityBorderColor, getPriorityLabel,
                exportData, triggerImport, handleImport, dayjs,
                isTodayARestDay 
            };
        }
    }).mount('#app');
</script>
</body>
</html>